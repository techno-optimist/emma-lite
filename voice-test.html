<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emma Voice Test - Phase 0</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #8a2be2;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #888;
            font-size: 16px;
        }
        
        .orb-container {
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
            position: relative;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #8a2be2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #7b27d1;
        }
        
        .btn-secondary {
            background: #333;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #444;
        }
        
        .status-container {
            margin-bottom: 30px;
        }
        
        .emma-voice-status {
            padding: 12px 20px;
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 8px;
            color: #8a2be2;
            text-align: center;
            font-size: 14px;
        }
        
        .emma-voice-status.error {
            background: rgba(220, 53, 69, 0.1);
            border-color: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }
        
        .logs {
            background: #222;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-info { color: #17a2b8; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
        
        .cto-notes {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .cto-notes h3 {
            color: #ffc107;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéôÔ∏è Emma Voice Test</h1>
        <p>Phase 0: WebRTC + Ephemeral Tokens + Orb Integration</p>
        <p><strong>Privacy-First Architecture</strong> ‚Ä¢ Built with love for Debbe üíú</p>
    </div>

    <div class="orb-container" id="orbContainer">
        <!-- Emma orb will be rendered here -->
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="toggleVoice()">Start Voice Session</button>
        <button class="btn btn-secondary" onclick="testToken()">Test Token API</button>
        <button class="btn btn-secondary" onclick="testTools()">Test Local Tools</button>
        <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="status-container" id="statusContainer">
        <!-- Voice status will appear here -->
    </div>

    <div class="cto-notes">
        <h3>üîí CTO Security Notes</h3>
        <ul>
            <li><strong>Privacy-First:</strong> All tools execute locally, no vault data sent to cloud</li>
            <li><strong>Ephemeral Tokens:</strong> 60-second tokens, no persistent API keys</li>
            <li><strong>Dementia-Friendly:</strong> Validation therapy tone, gentle error handling</li>
            <li><strong>Local-First:</strong> Voice enhances but never replaces core functionality</li>
        </ul>
    </div>

    <div class="logs" id="logs">
        <div class="log-entry log-info">üéôÔ∏è Emma Voice Test initialized</div>
    </div>

    <!-- Load Emma's existing orb system -->
    <script src="js/emma-orb.js"></script>
    <script src="js/emma-realtime-voice.js"></script>
    
    <script>
        let emmaVoice = null;
        let isVoiceActive = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Emma voice system
                emmaVoice = new EmmaRealtimeVoice({
                    wakeWord: 'Emma',
                    pacing: 2500,
                    validationMode: true
                });

                // Initialize with orb and status containers
                const orbContainer = document.getElementById('orbContainer');
                const statusContainer = document.getElementById('statusContainer');
                
                const success = await emmaVoice.initialize(orbContainer, statusContainer);
                
                if (success) {
                    addLog('‚úÖ Emma Voice system initialized successfully', 'success');
                } else {
                    addLog('‚ùå Emma Voice initialization failed', 'error');
                }
                
            } catch (error) {
                addLog(`‚ùå Initialization error: ${error.message}`, 'error');
            }
        });

        // Toggle voice session
        async function toggleVoice() {
            const btn = event.target;
            
            try {
                if (!isVoiceActive) {
                    btn.textContent = 'Starting...';
                    btn.disabled = true;
                    
                    await emmaVoice.startVoiceSession();
                    
                    btn.textContent = 'Stop Voice Session';
                    btn.className = 'btn btn-secondary';
                    isVoiceActive = true;
                    
                    addLog('üéôÔ∏è Voice session started', 'success');
                    
                } else {
                    btn.textContent = 'Stopping...';
                    btn.disabled = true;
                    
                    await emmaVoice.stopVoiceSession();
                    
                    btn.textContent = 'Start Voice Session';
                    btn.className = 'btn btn-primary';
                    isVoiceActive = false;
                    
                    addLog('üîá Voice session stopped', 'info');
                }
                
            } catch (error) {
                addLog(`‚ùå Voice toggle error: ${error.message}`, 'error');
                btn.textContent = 'Start Voice Session';
                btn.className = 'btn btn-primary';
                isVoiceActive = false;
                
            } finally {
                btn.disabled = false;
            }
        }

        // Test token API
        async function testToken() {
            addLog('üîë Testing ephemeral token API...', 'info');
            
            try {
                const backendUrl = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3001' 
                    : 'https://emma-voice-backend.onrender.com';
                    
                const response = await fetch(`${backendUrl}/api/realtime/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scope: 'voice',
                        model: 'gpt-4o-realtime-preview-2024-12-17'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    addLog(`‚úÖ Token obtained: expires in ${data.expires_in}s`, 'success');
                    addLog(`üìã Session ID: ${data.session_id}`, 'info');
                } else {
                    const error = await response.json();
                    addLog(`‚ùå Token error: ${error.error}`, 'error');
                }
                
            } catch (error) {
                addLog(`‚ùå Token request failed: ${error.message}`, 'error');
            }
        }

        // Test local tools (privacy-first)
        async function testTools() {
            addLog('üîß Testing local privacy-first tools...', 'info');
            
            try {
                if (!emmaVoice || !emmaVoice.tools) {
                    addLog('‚ùå Voice tools not initialized', 'error');
                    return;
                }

                // Test get_people (local only)
                const peopleResult = await emmaVoice.tools.execute('get_people', { query: '' });
                addLog(`üë• People tool: ${peopleResult.people?.length || 0} people found`, 'info');
                
                // Test get_memories (local only)
                const memoriesResult = await emmaVoice.tools.execute('get_memories', { limit: 3 });
                addLog(`üí≠ Memories tool: ${memoriesResult.memories?.length || 0} memories found`, 'info');
                
                addLog('‚úÖ All tools executed locally (privacy-first)', 'success');
                
            } catch (error) {
                addLog(`‚ùå Tools test error: ${error.message}`, 'error');
            }
        }

        // Clear logs
        function clearLogs() {
            const logs = document.getElementById('logs');
            logs.innerHTML = '<div class="log-entry log-info">üéôÔ∏è Logs cleared</div>';
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            // Also log to console
            console.log(message);
        }

        // Test health endpoint
        const backendUrl = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001' 
            : 'https://emma-voice-backend.onrender.com';
            
        fetch(`${backendUrl}/api/health`)
            .then(r => r.json())
            .then(data => {
                addLog(`üè• Backend health: ${data.status} (${data.privacy})`, 'success');
            })
            .catch(error => {
                addLog(`‚ùå Backend health check failed: ${error.message}`, 'error');
            });
    </script>
</body>
</html>

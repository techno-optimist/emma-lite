<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix Vault Passphrase</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1033;
      color: white;
    }
    .section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { opacity: 0.9; }
    button.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
    }
    .success { background: rgba(74, 222, 128, 0.2); }
    .error { background: rgba(248, 113, 113, 0.2); }
    .info { background: rgba(59, 130, 246, 0.2); }
    .warning { background: rgba(251, 191, 36, 0.2); }
    input {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px;
      border-radius: 4px;
      margin: 5px;
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>üîß Fix Vault Passphrase Issue</h1>
  
  <div class="section">
    <h2>üîç Quick Diagnosis</h2>
    <p>This tool will help you fix the "Invalid passphrase" error by resetting the vault verifier.</p>
    <button onclick="diagnose()">üîç Diagnose Issue</button>
    <div id="diagnosis" class="status info">Click "Diagnose Issue" to check your vault status</div>
  </div>

  <div class="section">
    <h2>üíä One-Click Fix</h2>
    <p><strong>Recommended:</strong> This will clear the verifier and let you create a fresh one.</p>
    <button onclick="quickFix()" class="danger">üöÄ Quick Fix (Clear Verifier)</button>
    <div id="fix-result" class="status"></div>
  </div>

  <div class="section">
    <h2>üîë Test Your Passphrase</h2>
    <p>After the fix, test your passphrase:</p>
    <input type="password" id="test-pass" placeholder="Enter your passphrase" value="demo">
    <button onclick="testUnlock()">üîì Test Unlock</button>
    <div id="test-result" class="status"></div>
  </div>

  <div class="section">
    <h2>üìã Step-by-Step Instructions</h2>
    <ol>
      <li><strong>Click "Quick Fix"</strong> to clear the corrupted verifier</li>
      <li><strong>Enter your passphrase</strong> in the test field</li>
      <li><strong>Click "Test Unlock"</strong> - this will recreate the verifier correctly</li>
      <li><strong>Your vault should now work normally!</strong></li>
    </ol>
  </div>

  <script>
    async function diagnose() {
      try {
        const storage = await chrome.storage.local.get(['emma_vault_settings', 'emma_vault_initialized']);
        const settings = storage.emma_vault_settings;
        const initialized = storage.emma_vault_initialized;
        
        const diagnosis = {
          vaultInitialized: !!initialized,
          hasSettings: !!settings,
          hasVerifier: !!(settings && settings.verifier),
          hasValidVerifier: !!(settings && settings.verifier && settings.verifier.iv && settings.verifier.data),
          demoMode: !!(settings && settings.demo),
          settingsKeys: settings ? Object.keys(settings) : []
        };
        
        let message = `Vault Diagnosis:\n`;
        message += `‚Ä¢ Vault Initialized: ${diagnosis.vaultInitialized ? '‚úÖ' : '‚ùå'}\n`;
        message += `‚Ä¢ Has Settings: ${diagnosis.hasSettings ? '‚úÖ' : '‚ùå'}\n`;
        message += `‚Ä¢ Has Verifier: ${diagnosis.hasVerifier ? '‚úÖ' : '‚ùå'}\n`;
        message += `‚Ä¢ Valid Verifier: ${diagnosis.hasValidVerifier ? '‚úÖ' : '‚ùå'}\n`;
        message += `‚Ä¢ Demo Mode: ${diagnosis.demoMode ? '‚úÖ' : '‚ùå'}\n`;
        
        if (!diagnosis.hasValidVerifier && diagnosis.vaultInitialized) {
          message += `\nüîß ISSUE FOUND: Verifier is missing or corrupted.\nRecommendation: Use Quick Fix to resolve.`;
        } else if (diagnosis.hasValidVerifier) {
          message += `\nüí° Verifier exists. The issue might be passphrase mismatch.\nTry entering the correct passphrase.`;
        }
        
        document.getElementById('diagnosis').className = diagnosis.hasValidVerifier ? 'status info' : 'status warning';
        document.getElementById('diagnosis').innerHTML = `<pre>${message}</pre>`;
        
      } catch (error) {
        document.getElementById('diagnosis').className = 'status error';
        document.getElementById('diagnosis').innerHTML = `<strong>‚ùå Diagnosis failed:</strong> ${error.message}`;
      }
    }

    async function quickFix() {
      if (!confirm('This will clear the vault verifier. You\'ll need to unlock once to recreate it. Continue?')) {
        return;
      }
      
      try {
        const storage = await chrome.storage.local.get(['emma_vault_settings']);
        const settings = storage.emma_vault_settings;
        
        if (settings && settings.verifier) {
          delete settings.verifier;
          await chrome.storage.local.set({ emma_vault_settings: settings });
          
          document.getElementById('fix-result').className = 'status success';
          document.getElementById('fix-result').innerHTML = `
            <strong>‚úÖ Fix Applied Successfully!</strong><br>
            The verifier has been cleared. Now:<br>
            1. Enter your passphrase below<br>
            2. Click "Test Unlock" to recreate the verifier<br>
            3. Your vault should work normally
          `;
        } else {
          document.getElementById('fix-result').className = 'status info';
          document.getElementById('fix-result').innerHTML = `<strong>‚ÑπÔ∏è No verifier found to clear.</strong> Try testing your unlock directly.`;
        }
      } catch (error) {
        document.getElementById('fix-result').className = 'status error';
        document.getElementById('fix-result').innerHTML = `<strong>‚ùå Fix failed:</strong> ${error.message}`;
      }
    }

    async function testUnlock() {
      try {
        const passphrase = document.getElementById('test-pass').value;
        if (!passphrase) {
          document.getElementById('test-result').className = 'status error';
          document.getElementById('test-result').innerHTML = '<strong>‚ùå Please enter a passphrase</strong>';
          return;
        }
        
        document.getElementById('test-result').className = 'status info';
        document.getElementById('test-result').innerHTML = '<strong>üîÑ Testing unlock...</strong>';
        
        const result = await chrome.runtime.sendMessage({
          action: 'vault.unlock',
          passphrase: passphrase
        });
        
        if (result && result.success) {
          document.getElementById('test-result').className = 'status success';
          document.getElementById('test-result').innerHTML = `
            <strong>‚úÖ Unlock Successful!</strong><br>
            Your vault is now working correctly.<br>
            The verifier has been recreated and future unlocks should work.
          `;
        } else {
          document.getElementById('test-result').className = 'status error';
          document.getElementById('test-result').innerHTML = `
            <strong>‚ùå Unlock Failed:</strong> ${result?.error || 'Unknown error'}<br>
            Try a different passphrase or contact support.
          `;
        }
      } catch (error) {
        document.getElementById('test-result').className = 'status error';
        document.getElementById('test-result').innerHTML = `<strong>‚ùå Test failed:</strong> ${error.message}`;
      }
    }

    // Auto-diagnose on load
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => diagnose(), 1000);
    });
  </script>
</body>
</html>

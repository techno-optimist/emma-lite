<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 CTO Testing Interface - Emma Architecture Revolution</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .mission {
            background: rgba(220, 38, 38, 0.2);
            border: 2px solid rgba(220, 38, 38, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .button.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }
        
        .status.enabled {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid rgba(16, 185, 129, 0.5);
        }
        
        .status.disabled {
            background: rgba(75, 85, 99, 0.2);
            border: 2px solid rgba(75, 85, 99, 0.5);
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 CTO Testing Interface</h1>
            <h2>Emma Architectural Revolution</h2>
        </div>
        
        <div class="mission">
            <h3>💜 MISSION: Perfect Demo for Debbe Tomorrow</h3>
            <p>Every change honors Debbe's memory. Zero tolerance for failure.</p>
        </div>
        
        <div class="grid">
            <div class="section">
                <h3>🏗️ Architecture Status</h3>
                <div id="architectureStatus" class="status disabled">
                    <strong>LEGACY ARCHITECTURE</strong><br>
                    Extension-Primary (Current)
                </div>
                
                <h4>🚩 Feature Flags:</h4>
                <div id="featureFlagsDisplay"></div>
                
                <button class="button" onclick="refreshStatus()">🔄 Refresh Status</button>
            </div>
            
            <div class="section">
                <h3>🎯 Architecture Control</h3>
                
                <h4>🚀 Enable New Architecture:</h4>
                <button class="button" onclick="enableWebAppPrimary()">
                    🚀 Enable Web App Primary
                </button>
                
                <h4>🛡️ Safety Controls:</h4>
                <button class="button warning" onclick="disableWebAppPrimary()">
                    🛡️ Rollback to Legacy
                </button>
                <button class="button danger" onclick="emergencyRollback()">
                    🚨 Emergency Rollback
                </button>
            </div>
        </div>
        
        <div class="section">
            <h3>🧪 Testing Protocol</h3>
            
            <h4>Phase 2 Tests:</h4>
            <button class="button" onclick="testVaultPersistence()">📊 Test Vault Persistence</button>
            <button class="button" onclick="testImageCapture()">🖼️ Test Image Capture</button>
            <button class="button" onclick="testMemoryCreation()">💝 Test Memory Creation</button>
            <button class="button" onclick="testConstellation()">🌟 Test Constellation</button>
            
            <h4>Stress Tests:</h4>
            <button class="button" onclick="testPageRefresh()">🔄 Test Page Refresh</button>
            <button class="button" onclick="testExtensionReload()">🔌 Test Extension Reload</button>
            <button class="button" onclick="testDataIntegrity()">🛡️ Test Data Integrity</button>
        </div>
        
        <div class="section">
            <h3>📊 System Diagnostics</h3>
            <button class="button" onclick="runDiagnostics()">🔍 Run Full Diagnostics</button>
            <button class="button" onclick="clearLogs()">🧹 Clear Logs</button>
            
            <div id="diagnosticsLog" class="log">
                <div>🚀 CTO Testing Interface Ready</div>
                <div>💜 For Debbe - Building perfect memory preservation</div>
                <div>📋 Use buttons above to test architecture changes</div>
            </div>
        </div>
    </div>

    <!-- Load Emma Systems -->
    <script src="js/emma-input-modal.js"></script>
    <script src="js/clean-password-modal.js"></script>
    <script src="js/emma-feature-flags.js"></script>
    <script src="js/emma-vault-primary.js"></script>
    <script src="js/emma-web-vault.js"></script>
    <script src="js/web-vault-status.js"></script>
    
    <script>
        // CTO Testing Interface Functions
        
        function log(message) {
            const logDiv = document.getElementById('diagnosticsLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #10b981">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function refreshStatus() {
            try {
                const flags = window.emmaFeatureFlags ? window.emmaFeatureFlags.getAll() : {};
                const isPrimary = flags.USE_WEBAPP_PRIMARY;
                
                // Update architecture status
                const statusDiv = document.getElementById('architectureStatus');
                if (isPrimary) {
                    statusDiv.className = 'status enabled';
                    statusDiv.innerHTML = '<strong>🚀 WEB APP PRIMARY</strong><br>Revolutionary Architecture Active';
                } else {
                    statusDiv.className = 'status disabled';
                    statusDiv.innerHTML = '<strong>🔧 LEGACY ARCHITECTURE</strong><br>Extension-Primary (Current)';
                }
                
                // Update feature flags display
                const flagsDiv = document.getElementById('featureFlagsDisplay');
                flagsDiv.innerHTML = Object.entries(flags)
                    .map(([flag, enabled]) => 
                        `<div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                            <strong>${flag}:</strong> 
                            <span style="color: ${enabled ? '#10b981' : '#6b7280'}">${enabled ? 'ENABLED' : 'DISABLED'}</span>
                        </div>`
                    ).join('');
                
                log('📊 Status refreshed');
            } catch (error) {
                log('❌ Failed to refresh status: ' + error.message);
            }
        }
        
        function enableWebAppPrimary() {
            try {
                log('🚀 CTO: Enabling Web App Primary Architecture...');
                
                if (window.enableWebAppPrimary) {
                    window.enableWebAppPrimary();
                    log('✅ Web App Primary Architecture ENABLED');
                    log('🔄 Please refresh the main web app to apply changes');
                } else {
                    log('❌ Feature flag system not available');
                }
                
                refreshStatus();
            } catch (error) {
                log('❌ Failed to enable Web App Primary: ' + error.message);
            }
        }
        
        function disableWebAppPrimary() {
            try {
                log('🛡️ CTO: Rolling back to Legacy Architecture...');
                
                if (window.disableWebAppPrimary) {
                    window.disableWebAppPrimary();
                    log('✅ Rolled back to Legacy Architecture');
                    log('🔄 Please refresh the main web app to apply changes');
                } else {
                    log('❌ Feature flag system not available');
                }
                
                refreshStatus();
            } catch (error) {
                log('❌ Failed to rollback: ' + error.message);
            }
        }
        
        function emergencyRollback() {
            try {
                log('🚨 EMERGENCY ROLLBACK: Disabling ALL experimental features...');
                
                if (window.emergencyRollback) {
                    window.emergencyRollback();
                    log('✅ Emergency rollback initiated');
                } else {
                    log('❌ Emergency rollback system not available');
                }
            } catch (error) {
                log('❌ Emergency rollback failed: ' + error.message);
            }
        }
        
        async function uploadAndTestVault() {
            try {
                log('📁 Testing vault upload...');
                
                const fileInput = document.getElementById('vaultFileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    log('❌ No file selected. Please select a .emma vault file first.');
                    return;
                }
                
                if (!file.name.endsWith('.emma')) {
                    log('❌ Invalid file type. Please select a .emma vault file.');
                    return;
                }
                
                log('📖 Reading vault file: ' + file.name);
                
                // Read file data
                const fileData = new Uint8Array(await file.arrayBuffer());
                log('✅ File read successfully, size: ' + fileData.length + ' bytes');
                
                // Request passphrase using Emma's secure modal
                log('🔐 Requesting passphrase using secure Emma modal...');
                let passphrase;
                try {
                    if (window.cleanSecurePasswordModal) {
                        passphrase = await window.cleanSecurePasswordModal.show({
                            title: 'Unlock Vault for Testing',
                            message: `Enter the passphrase for your vault: ${file.name}`,
                            placeholder: 'Enter vault passphrase...'
                        });
                    } else {
                        log('⚠️ Secure modal not available, using fallback');
                        passphrase = prompt('🔐 Enter vault passphrase:');
                    }
                } catch (error) {
                    if (error.message === 'User cancelled') {
                        log('❌ Passphrase entry cancelled');
                        return;
                    }
                    throw error;
                }
                
                if (!passphrase) {
                    log('❌ Passphrase required for testing');
                    return;
                }
                
                log('🔓 Attempting to decrypt vault...');
                
                // Test decryption
                if (window.emmaVaultPrimary) {
                    try {
                        const result = await window.emmaVaultPrimary.requestDecryption(fileData, passphrase);
                        if (result.success) {
                            log('✅ Vault decrypted successfully!');
                            log('📊 Memories found: ' + Object.keys(result.vaultData.content?.memories || {}).length);
                            log('👥 People found: ' + Object.keys(result.vaultData.content?.people || {}).length);
                            log('📷 Media found: ' + Object.keys(result.vaultData.content?.media || {}).length);
                            
                            // Update status
                            const statusDiv = document.getElementById('vaultTestStatus');
                            statusDiv.className = 'status enabled';
                            statusDiv.innerHTML = `
                                <strong>✅ VAULT LOADED</strong><br>
                                ${file.name}<br>
                                Memories: ${Object.keys(result.vaultData.content?.memories || {}).length} | 
                                People: ${Object.keys(result.vaultData.content?.people || {}).length}
                            `;
                            
                        } else {
                            log('❌ Decryption failed: ' + result.error);
                        }
                    } catch (error) {
                        log('❌ Vault testing failed: ' + error.message);
                    }
                } else {
                    log('❌ EmmaVaultPrimary not available');
                }
                
            } catch (error) {
                log('❌ Upload test failed: ' + error.message);
            }
        }
        
        function testCreateNewVault() {
            log('🆕 Testing new vault creation...');
            log('📝 Manual test required:');
            log('  1. Go to main web app');
            log('  2. Click "Create New Vault"');
            log('  3. Enter vault name and passphrase');
            log('  4. Verify vault creates successfully');
            log('  5. Verify vault persists after page refresh');
        }
        
        function testVaultLocking() {
            log('🔒 Testing vault locking...');
            log('📝 Manual test required:');
            log('  1. Ensure vault is unlocked');
            log('  2. Click lock button');
            log('  3. Verify vault locks properly');
            log('  4. Verify data is encrypted and saved');
            log('  5. Test unlock with correct passphrase');
        }
        
        function testVaultPersistence() {
            log('🧪 Testing vault persistence...');
            log('📝 Check: Does vault data survive page refresh?');
            log('📝 Check: Does IndexedDB contain vault data?');
            log('📝 Manual test required - refresh main web app');
        }
        
        function testImageCapture() {
            log('🧪 Testing image capture...');
            log('📝 Manual test required:');
            log('  1. Open main web app');
            log('  2. Open extension popup');
            log('  3. Click "Capture Images" on any website');
            log('  4. Verify images are detected and selectable');
        }
        
        function testMemoryCreation() {
            log('🧪 Testing memory creation...');
            log('📝 Manual test required:');
            log('  1. Capture images from website');
            log('  2. Create memory capsule');
            log('  3. Verify memory appears in constellation');
            log('  4. Verify memory persists after page refresh');
        }
        
        function testConstellation() {
            log('🧪 Testing constellation view...');
            log('📝 Manual test required:');
            log('  1. Open main web app');
            log('  2. Click memories button');
            log('  3. Verify constellation loads');
            log('  4. Verify memory dialogs open');
        }
        
        function testPageRefresh() {
            log('🧪 Testing page refresh...');
            log('📝 Manual test required:');
            log('  1. Ensure vault is unlocked with memories');
            log('  2. Refresh main web app (F5)');
            log('  3. Verify vault stays unlocked');
            log('  4. Verify all memories still visible');
        }
        
        function testExtensionReload() {
            log('🧪 Testing extension reload...');
            log('📝 Manual test required:');
            log('  1. Ensure vault is unlocked with memories');
            log('  2. Go to chrome://extensions/');
            log('  3. Click reload on Emma extension');
            log('  4. Verify vault stays unlocked');
            log('  5. Verify all memories still visible');
        }
        
        function testDataIntegrity() {
            log('🧪 Testing data integrity...');
            log('📝 Manual test required:');
            log('  1. Create test memory with images');
            log('  2. Refresh page multiple times');
            log('  3. Reload extension multiple times');
            log('  4. Verify memory data never corrupts');
            log('  5. Verify image attachments always load');
        }
        
        function runDiagnostics() {
            try {
                log('🔍 Running full system diagnostics...');
                
                // Check feature flags
                const flags = window.emmaFeatureFlags ? window.emmaFeatureFlags.getAll() : null;
                log('🚩 Feature flags: ' + (flags ? 'LOADED' : 'NOT LOADED'));
                
                // Check vault systems with detailed error info
                try {
                    log('🔧 EmmaWebVault: ' + (window.emmaWebVault ? 'LOADED' : 'NOT LOADED'));
                    if (window.EmmaWebVault) {
                        log('📦 EmmaWebVault class: AVAILABLE');
                    }
                } catch (e) {
                    log('❌ EmmaWebVault error: ' + e.message);
                }
                
                try {
                    log('🚀 EmmaVaultPrimary: ' + (window.emmaVaultPrimary ? 'LOADED' : 'NOT LOADED'));
                    if (window.EmmaVaultPrimary) {
                        log('📦 EmmaVaultPrimary class: AVAILABLE');
                    }
                } catch (e) {
                    log('❌ EmmaVaultPrimary error: ' + e.message);
                }
                
                try {
                    log('📊 WebVaultStatus: ' + (window.webVaultStatus ? 'LOADED' : 'NOT LOADED'));
                    if (window.WebVaultStatus) {
                        log('📦 WebVaultStatus class: AVAILABLE');
                    }
                } catch (e) {
                    log('❌ WebVaultStatus error: ' + e.message);
                }
                
                // Check current vault status
                if (window.currentVaultStatus) {
                    log('🔓 Vault Status: ' + (window.currentVaultStatus.isUnlocked ? 'UNLOCKED' : 'LOCKED'));
                    log('📁 Vault Name: ' + (window.currentVaultStatus.name || 'None'));
                } else {
                    log('❌ No vault status available');
                }
                
                // Check extension connection (expected to fail on Render)
                if (window.chrome && window.chrome.runtime) {
                    log('🔌 Extension API: AVAILABLE');
                } else {
                    log('🌐 Extension API: NOT AVAILABLE (expected on Render)');
                }
                
                // Check File System Access API
                if (window.showOpenFilePicker) {
                    log('📁 File System Access API: SUPPORTED');
                } else {
                    log('⚠️ File System Access API: NOT SUPPORTED');
                }
                
                // Check script loading errors
                const scripts = document.querySelectorAll('script[src]');
                log(`📜 Scripts loaded: ${scripts.length}`);
                scripts.forEach((script, index) => {
                    const src = script.src.split('/').pop();
                    log(`  ${index + 1}. ${src}: ${script.readyState || 'unknown'}`);
                });
                
                log('✅ Diagnostics complete');
                
            } catch (error) {
                log('❌ Diagnostics failed: ' + error.message);
                console.error('Full diagnostic error:', error);
            }
        }
        
        function clearLogs() {
            document.getElementById('diagnosticsLog').innerHTML = 
                '<div>🧹 Logs cleared</div><div>📋 Ready for new tests</div>';
        }
        
        // Auto-refresh status on load
        document.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
            runDiagnostics();
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 CTO Testing Interface</h1>
            <h2>Emma Architectural Revolution</h2>
            <p>Safe migration from Extension-Primary to Web App-Primary</p>
        </div>
        
        <div class="mission">
            <h3>💜 MISSION: Perfect Demo for Debbe Tomorrow</h3>
            <p><strong>DEADLINE:</strong> 12 hours | <strong>RISK TOLERANCE:</strong> Zero | <strong>OBJECTIVE:</strong> Bulletproof vault persistence</p>
        </div>
        
        <div class="grid">
            <div class="section">
                <h3>🏗️ Architecture Status</h3>
                <div id="architectureStatus" class="status disabled">
                    Loading...
                </div>
                
                <h4>🚩 Feature Flags:</h4>
                <div id="featureFlagsDisplay">Loading...</div>
                
                <button class="button" onclick="refreshStatus()">🔄 Refresh Status</button>
            </div>
            
            <div class="section">
                <h3>🎯 Architecture Control</h3>
                
                <h4>🚀 Enable New Architecture:</h4>
                <button class="button" onclick="enableWebAppPrimary()">
                    🚀 Enable Web App Primary
                </button>
                <p style="font-size: 14px; opacity: 0.8;">
                    Enables bulletproof web app vault management
                </p>
                
                <h4>🛡️ Safety Controls:</h4>
                <button class="button warning" onclick="disableWebAppPrimary()">
                    🛡️ Rollback to Legacy
                </button>
                <button class="button danger" onclick="emergencyRollback()">
                    🚨 Emergency Rollback
                </button>
            </div>
        </div>
        
        <div class="section">
            <h3>🔓 Vault Testing</h3>
            
            <h4>📁 Upload .emma Vault File:</h4>
            <input type="file" id="vaultFileInput" accept=".emma" style="
                background: rgba(255, 255, 255, 0.1);
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 10px;
                padding: 10px;
                color: white;
                margin: 10px 0;
                width: 100%;
            ">
            <button class="button" onclick="uploadAndTestVault()">🔓 Upload & Test Vault</button>
            
            <h4>🎯 Vault Operations:</h4>
            <button class="button" onclick="testCreateNewVault()">🆕 Test Create New Vault</button>
            <button class="button" onclick="testVaultLocking()">🔒 Test Vault Locking</button>
            <button class="button" onclick="testVaultPersistence()">💾 Test Persistence</button>
            
            <div id="vaultTestStatus" class="status disabled" style="margin-top: 15px;">
                <strong>No vault loaded</strong><br>
                Upload a .emma file to begin testing
            </div>
        </div>
        
        <div class="section">
            <h3>🧪 Core Functionality Tests</h3>
            
            <h4>Memory Operations:</h4>
            <button class="button" onclick="testMemoryCreation()">💝 Test Memory Creation</button>
            <button class="button" onclick="testConstellation()">🌟 Test Constellation</button>
            <button class="button" onclick="testImageCapture()">🖼️ Test Image Capture</button>
            
            <h4>Stress Tests:</h4>
            <button class="button" onclick="testPageRefresh()">🔄 Test Page Refresh</button>
            <button class="button" onclick="testExtensionReload()">🔌 Test Extension Reload</button>
            <button class="button" onclick="testDataIntegrity()">🛡️ Test Data Integrity</button>
        </div>
        
        <div class="section">
            <h3>📊 System Diagnostics</h3>
            <button class="button" onclick="runDiagnostics()">🔍 Run Full Diagnostics</button>
            <button class="button" onclick="clearLogs()">🧹 Clear Logs</button>
            
            <div id="diagnosticsLog" class="log">
                <div>🚀 CTO Testing Interface Loading...</div>
            </div>
        </div>
        
        <div class="section">
            <h3>🎯 Quick Links</h3>
            <a href="working-desktop-dashboard.html" target="_blank" class="button">🌐 Open Main Web App</a>
            <a href="emma-vault-extension-fixed/popup.html" target="_blank" class="button">🔌 Open Extension Popup</a>
            <a href="ARCHITECTURAL-REVOLUTION-TODO.md" target="_blank" class="button">📋 View Battle Plan</a>
        </div>
        
        <div style="text-align: center; margin-top: 40px; opacity: 0.8;">
            <p>💜 <strong>For Debbe:</strong> Every line of code honors her memory</p>
            <p>🎯 <strong>Mission:</strong> Preserve precious memories with absolute reliability</p>
        </div>
    </div>
</body>
</html>

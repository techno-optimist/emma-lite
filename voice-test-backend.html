<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emma Voice Backend Test</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #fff; padding: 20px; }
        .log { background: #333; padding: 10px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #8a2be2; color: white; }
        .btn-secondary { background: #666; color: white; }
    </style>
</head>
<body>
    <h1>üéôÔ∏è Emma Voice Backend Test</h1>
    <p>Testing the server-side Emma agent directly</p>
    
    <button class="btn-primary" onclick="testBackend()">Test Backend Connection</button>
    <button class="btn-secondary" onclick="clearLogs()">Clear Logs</button>
    
    <div id="logs"></div>

    <script>
        // Copy of EmmaVoiceTools for testing
        class EmmaVoiceTools {
            constructor() {
                this.tools = {
                    get_people: async () => ({ people: [] }),
                    get_memories: async () => ({ memories: [] }),
                    create_memory_from_voice: async () => ({ success: true }),
                    update_person: async () => ({ success: true })
                };
            }
            
            async execute(toolName, params) {
                return await this.tools[toolName](params);
            }
        }

        // Simple browser client for testing
        class TestBrowserClient {
            constructor() {
                this.websocket = null;
                this.isConnected = false;
                this.tools = new EmmaVoiceTools();
            }

            async startVoiceSession() {
                try {
                    log('üîó Connecting to Emma backend...');
                    
                    const wsUrl = 'wss://emma-voice-backend.onrender.com/voice';
                    this.websocket = new WebSocket(wsUrl);
                    
                    this.websocket.onopen = () => {
                        log('‚úÖ Connected to Emma backend');
                        this.isConnected = true;
                        
                        // Start Emma session
                        this.websocket.send(JSON.stringify({
                            type: 'start_session',
                            config: {
                                voice: 'alloy',
                                tone: 'caring',
                                pacing: 2.5
                            }
                        }));
                    };
                    
                    this.websocket.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        log(`üì® Emma: ${message.type} - ${message.message || JSON.stringify(message)}`);
                        
                        if (message.type === 'tool_request') {
                            // Handle tool request
                            this.handleToolRequest(message);
                        }
                    };
                    
                    this.websocket.onerror = (error) => {
                        log(`‚ùå WebSocket error: ${error}`);
                    };
                    
                    this.websocket.onclose = () => {
                        log('üîá Emma connection closed');
                        this.isConnected = false;
                    };
                    
                } catch (error) {
                    log(`‚ùå Connection failed: ${error.message}`);
                }
            }
            
            async handleToolRequest(message) {
                try {
                    const result = await this.tools.execute(message.tool_name, message.parameters);
                    
                    this.websocket.send(JSON.stringify({
                        type: 'tool_result',
                        call_id: message.call_id,
                        result: JSON.stringify(result)
                    }));
                    
                    log(`üîß Tool executed: ${message.tool_name}`);
                    
                } catch (error) {
                    log(`‚ùå Tool error: ${error.message}`);
                }
            }
        }

        let testClient = new TestBrowserClient();

        function testBackend() {
            testClient.startVoiceSession();
        }

        function log(message) {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(logDiv);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        log('üéôÔ∏è Emma Voice Backend Test ready');
    </script>
</body>
</html>

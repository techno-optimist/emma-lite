<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Emma</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    .settings-container {
      max-width: 700px;
      margin: 0 auto;
    }
    
    .setting-section {
      background: var(--emma-card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--emma-border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .setting-section h3 {
      font-size: 20px;
      margin-bottom: 24px;
      color: var(--emma-text);
    }
    
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--emma-border);
    }
    
    .setting-item:last-child {
      border-bottom: none;
    }
    
    .setting-label {
      flex: 1;
    }
    
    .setting-label strong {
      display: block;
      color: var(--emma-text);
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .setting-label small {
      color: var(--emma-text-secondary);
      font-size: 13px;
      line-height: 1.4;
    }
    
    /* Toggle Switch */
    .toggle {
      position: relative;
      width: 48px;
      height: 24px;
    }
    
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      transition: all 0.3s ease;
      border: 1px solid var(--emma-border);
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    input:checked + .slider {
      background: var(--emma-gradient-1);
      border-color: transparent;
    }
    
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    
    input:disabled + .slider {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Number Input */
    .number-input {
      width: 100px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--emma-border);
      border-radius: 8px;
      color: var(--emma-text);
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .number-input:focus {
      outline: none;
      border-color: var(--emma-purple);
      box-shadow: 0 0 20px rgba(118, 75, 162, 0.3);
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 24px 0;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--emma-border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 600;
      background: var(--emma-gradient-1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: block;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--emma-text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Button Group */
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    .btn-danger {
      background: rgba(248, 113, 113, 0.2);
      border: 1px solid rgba(248, 113, 113, 0.5);
      color: var(--emma-error);
    }
    
    .btn-danger:hover {
      background: rgba(248, 113, 113, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(248, 113, 113, 0.2);
    }
    
    /* MTAP Section */
    .mtap-status {
      background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%);
      border: 1px solid rgba(118, 75, 162, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .mtap-icon {
      font-size: 32px;
    }
    
    .mtap-info {
      flex: 1;
    }
    
    .mtap-info h4 {
      margin: 0 0 4px 0;
      color: var(--emma-text);
    }
    
    .mtap-info p {
      margin: 0;
      font-size: 13px;
      color: var(--emma-text-secondary);
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      background: var(--emma-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--emma-border);
      border-radius: 12px;
      padding: 16px 24px;
      color: var(--emma-text);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification.success {
      border-color: var(--emma-success);
      color: var(--emma-success);
    }
    
    .notification.error {
      border-color: var(--emma-error);
      color: var(--emma-error);
    }
    
    /* Vault Backup & Restore Styles */
    .file-upload-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .import-status {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }
    
    .import-status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
      display: block;
    }
    
    .import-status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      display: block;
    }
    
    .import-status.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
      display: block;
    }
    
    /* Enhanced Vault Backup Section Styles */
    .vault-backup-section {
      background: linear-gradient(135deg, var(--emma-card-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
    }

    .vault-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .vault-status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.status-loading {
      background: var(--emma-warning);
      animation: pulse 1.5s infinite;
    }

    .status-dot.status-unlocked {
      background: var(--emma-success);
    }

    .status-dot.status-locked {
      background: var(--emma-error);
    }

    .status-dot.status-error {
      background: #fbbf24;
    }

    .vault-stats-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid var(--emma-border);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--emma-text);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--emma-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .backup-actions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .backup-action-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--emma-border);
      transition: all 0.3s ease;
    }

    .backup-action-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .action-icon {
      font-size: 32px;
      margin-bottom: 12px;
      display: block;
    }

    .action-content h4 {
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--emma-text);
    }

    .action-content p {
      font-size: 13px;
      color: var(--emma-text-secondary);
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .backup-status {
      min-height: 20px;
      margin-bottom: 20px;
    }

    .backup-status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
    }

    .backup-status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
    }

    .backup-status.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
    }

    .vault-info-panel {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--emma-border);
    }

    .info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .info-header h4 {
      font-size: 16px;
      color: var(--emma-text);
      margin: 0;
    }

    .btn-link {
      background: none;
      border: none;
      color: var(--emma-text-secondary);
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .btn-link:hover {
      color: var(--emma-text);
      background: rgba(255, 255, 255, 0.05);
    }

    .vault-details {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .detail-label {
      font-size: 14px;
      color: var(--emma-text-secondary);
    }

    .detail-value {
      font-size: 14px;
      color: var(--emma-text);
      font-family: 'Courier New', monospace;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-indicator {
      font-size: 12px;
    }

    .btn-icon {
      margin-right: 8px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Legacy vault-info for compatibility */
    .vault-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px;
      border: 1px solid var(--emma-border);
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      font-size: 14px;
    }
    
    .info-row:not(:last-child) {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 8px;
      padding-bottom: 8px;
    }
    
    .info-row span:first-child {
      opacity: 0.8;
    }
    
    .info-row span:last-child {
      font-weight: 500;
      color: var(--emma-primary);
    }

    /* Migration Section Styles */
    .migration-section {
      background: linear-gradient(135deg, var(--emma-card-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .migration-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .migration-status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--emma-text-secondary);
    }

    .migration-description {
      color: var(--emma-text-secondary);
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .migration-analysis {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .analysis-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .analysis-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      font-size: 14px;
    }

    .analysis-label {
      color: var(--emma-text-secondary);
    }

    .analysis-value {
      font-weight: 600;
      color: var(--emma-text-primary);
    }

    .migration-options {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .migration-options h4 {
      margin: 0 0 12px 0;
      color: var(--emma-text-primary);
      font-size: 16px;
    }

    .option-grid {
      display: grid;
      gap: 12px;
    }

    .option-item {
      padding: 12px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 6px;
    }

    .option-item label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      color: var(--emma-text-primary);
      cursor: pointer;
    }

    .option-item small {
      color: var(--emma-text-secondary);
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }

    .migration-progress {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .migration-progress h4 {
      margin: 0 0 12px 0;
      color: var(--emma-text-primary);
      font-size: 16px;
    }

    .progress-info {
      text-align: center;
    }

    .progress-phase {
      margin-bottom: 8px;
      color: var(--emma-text-secondary);
      font-size: 14px;
    }

    .progress-bar {
      width: 100%;
      height: 16px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--emma-primary) 0%, var(--emma-accent) 100%);
      transition: width 0.3s ease;
      border-radius: 8px;
    }

    .progress-percentage {
      font-weight: 600;
      color: var(--emma-text-primary);
      font-size: 14px;
    }

    .migration-results {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .migration-results h4 {
      margin: 0 0 12px 0;
      color: var(--emma-text-primary);
      font-size: 16px;
    }

    .results-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
    }

    .result-item.success {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .result-item.warning {
      background: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }

    .result-item.error {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    .migration-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
    }

    .btn-info {
      background: linear-gradient(135deg, #29b6f6 0%, #1e88e5 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-info:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(29, 182, 246, 0.3);
    }

    .migration-status {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--emma-text-secondary);
      max-height: 200px;
      overflow-y: auto;
    }

    .status-unknown {
      background: #9e9e9e;
    }

    /* Password Modal Styles (from popup.css) */
    .password-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    .password-modal-content {
      background: var(--emma-bg-secondary);
      border: 1px solid var(--emma-border);
      border-radius: 12px;
      width: 280px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    .password-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px 12px;
      border-bottom: 1px solid var(--emma-border);
    }

    .password-modal-header h3 {
      color: var(--emma-text);
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .password-modal-close {
      background: none;
      border: none;
      color: var(--emma-text-secondary);
      font-size: 20px;
      cursor: pointer;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .password-modal-close:hover {
      color: var(--emma-text);
      background: rgba(255, 255, 255, 0.1);
    }

    .password-modal-body {
      padding: 16px 20px 20px;
    }

    .password-modal-input {
      width: 100%;
      padding: 12px 14px;
      background: var(--emma-bg);
      border: 1px solid var(--emma-border);
      border-radius: 8px;
      color: var(--emma-text);
      font-size: 14px;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin-bottom: 16px;
      text-align: center;
      letter-spacing: 2px;
    }

    .password-modal-input:focus {
      outline: none;
      border-color: var(--emma-purple);
      background: var(--emma-bg-secondary);
      box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2);
    }

    .password-modal-input::placeholder {
      color: var(--emma-text-tertiary);
      letter-spacing: 2px;
    }

    .password-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .password-modal-actions button {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .password-modal-actions .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--emma-text-secondary);
      border: 1px solid var(--emma-border);
    }

    .password-modal-actions .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.12);
      color: var(--emma-text);
    }

    .password-modal-actions .btn-primary {
      background: var(--emma-gradient-2);
      color: white;
      min-width: 60px;
    }

    .password-modal-actions .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .password-modal-actions .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    /* Orb Manager Styles */
    .section-description {
      color: var(--emma-text-secondary);
      font-size: 14px;
      margin: -16px 0 24px 0;
    }
    
    .orb-customizer {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .color-picker-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .color-picker-group label {
      font-size: 14px;
      color: var(--emma-text-secondary);
    }
    
    .size-selector {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .size-selector input[type="range"] {
      width: 200px;
      height: 6px;
      border-radius: 3px;
      background: var(--emma-border);
      outline: none;
      -webkit-appearance: none;
    }
    
    .size-selector input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--emma-primary);
      cursor: pointer;
    }
    
    .size-selector input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--emma-primary);
      cursor: pointer;
      border: none;
    }
    
    #orb-size-value {
      font-size: 14px;
      color: var(--emma-text-secondary);
      min-width: 48px;
    }
    
    .orb-preview-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--emma-border);
    }
    
    .orb-preview-section h4 {
      font-size: 16px;
      margin-bottom: 16px;
      color: var(--emma-text);
    }
    
    .orb-preview-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 32px;
      background: rgba(139, 92, 246, 0.05);
      border-radius: 12px;
      border: 1px solid var(--emma-border);
    }
    
    .orb-preview {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .orb-preview:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 40px rgba(139, 92, 246, 0.4);
    }
    
    .preview-note {
      font-size: 13px;
      color: var(--emma-text-secondary);
      margin: 0;
    }
    
    /* Modern Orb Avatar Selector */
    .orb-avatar-selector {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      margin: 32px 0;
    }
    
    .orb-option {
      display: flex;
      align-items: center;
      padding: 24px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid transparent;
      border-radius: 16px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      backdrop-filter: blur(10px);
    }
    
    .orb-option:hover {
      border-color: var(--emma-primary);
      background: rgba(139, 92, 246, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(139, 92, 246, 0.2);
    }
    
    .orb-option.active {
      border-color: var(--emma-primary);
      background: rgba(139, 92, 246, 0.15);
      box-shadow: 0 4px 24px rgba(139, 92, 246, 0.3);
    }
    
    .orb-avatar {
      width: 80px;
      height: 80px;
      margin-right: 24px;
      position: relative;
    }
    
    .orb-avatar .orb-container {
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }
    
    .orb-info {
      flex: 1;
    }
    
    .orb-info h4 {
      margin: 0 0 8px 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--emma-text);
    }
    
    .orb-info p {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--emma-text-secondary);
      line-height: 1.4;
    }
    
    .orb-color-indicator {
      font-size: 12px;
      color: var(--emma-primary);
      font-weight: 500;
    }
    
    .orb-status-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 6px 12px;
      background: var(--emma-gradient-1);
      color: white;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      z-index: 2;
      transition: all 0.2s ease;
    }
    
    .orb-status-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    .orb-status-badge.inactive {
      background: rgba(255, 255, 255, 0.1);
      color: var(--emma-text-secondary);
    }
    
    /* Orb Settings Dialog */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .orb-dialog {
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      background: var(--emma-bg);
      border-radius: 24px;
      border: 1px solid var(--emma-border);
      overflow: hidden;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.4);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .orb-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 32px;
      border-bottom: 1px solid var(--emma-border);
      background: rgba(139, 92, 246, 0.05);
    }
    
    .orb-dialog-title {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .dialog-orb-preview {
      width: 64px;
      height: 64px;
    }
    
    .dialog-orb-preview .orb-container {
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }
    
    .title-text h3 {
      margin: 0 0 4px 0;
      font-size: 24px;
      font-weight: 600;
      color: var(--emma-text);
    }
    
    .title-text p {
      margin: 0;
      font-size: 14px;
      color: var(--emma-text-secondary);
    }
    
    .dialog-close {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: var(--emma-text);
      border-radius: 12px;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .dialog-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .orb-dialog-content {
      overflow-y: auto;
      max-height: 60vh;
    }
    
    .dialog-tabs {
      display: flex;
      border-bottom: 1px solid var(--emma-border);
      background: rgba(255, 255, 255, 0.02);
    }
    
    .tab-button {
      flex: 1;
      padding: 16px 24px;
      border: none;
      background: transparent;
      color: var(--emma-text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 2px solid transparent;
    }
    
    .tab-button:hover {
      color: var(--emma-text);
      background: rgba(255, 255, 255, 0.05);
    }
    
    .tab-button.active {
      color: var(--emma-primary);
      border-bottom-color: var(--emma-primary);
    }
    
    .tab-content {
      display: none;
      padding: 32px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .setting-group {
      margin-bottom: 40px;
    }
    
    .setting-group:last-child {
      margin-bottom: 0;
    }
    
    .setting-group h4 {
      margin: 0 0 24px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--emma-text);
    }
    
    .setting-row {
      margin-bottom: 24px;
    }
    
    .setting-row:last-child {
      margin-bottom: 0;
    }
    
    .setting-row label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--emma-text);
    }
    
    .toggle-setting {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .toggle-setting label {
      margin-bottom: 0;
    }
    
    .color-theme-selector {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    
    .color-option {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      font-weight: bold;
    }
    
    .color-option:hover {
      transform: scale(1.1);
    }
    
    .color-option.active {
      border-color: white;
      box-shadow: 0 0 0 2px var(--emma-primary);
    }
    
    .size-control {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 8px;
    }
    
    .size-control input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--emma-border);
      outline: none;
      -webkit-appearance: none;
    }
    
    .size-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--emma-primary);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    
    .size-control span {
      font-size: 14px;
      color: var(--emma-text-secondary);
      min-width: 48px;
      text-align: right;
    }
    
    .position-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 8px;
    }
    
    .position-option {
      padding: 16px;
      border: 2px solid var(--emma-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    
    .position-option:hover {
      border-color: var(--emma-primary);
    }
    
    .position-option.active {
      border-color: var(--emma-primary);
      background: rgba(139, 92, 246, 0.1);
    }
    
    .position-preview {
      width: 60px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      margin: 0 auto 8px;
      position: relative;
    }
    
    .mini-orb {
      width: 8px;
      height: 8px;
      background: var(--emma-primary);
      border-radius: 50%;
      position: absolute;
    }
    
    .mini-orb.top-left { top: 4px; left: 4px; }
    .mini-orb.top-right { top: 4px; right: 4px; }
    .mini-orb.bottom-left { bottom: 4px; left: 4px; }
    .mini-orb.bottom-right { bottom: 4px; right: 4px; }
    
    .position-option span {
      font-size: 12px;
      color: var(--emma-text-secondary);
    }
    
    .sub-setting {
      margin-top: 16px;
      padding-left: 16px;
      border-left: 2px solid var(--emma-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sub-setting label {
      margin-bottom: 0;
      font-size: 13px;
    }
    
    .sub-setting input[type="number"] {
      width: 60px;
      padding: 4px 8px;
      border: 1px solid var(--emma-border);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--emma-text);
      font-size: 14px;
    }
    
    .text-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--emma-border);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--emma-text);
      font-size: 14px;
      margin-top: 8px;
    }
    
    .text-input:focus {
      outline: none;
      border-color: var(--emma-primary);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .orb-dialog-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 32px;
      border-top: 1px solid var(--emma-border);
      background: rgba(255, 255, 255, 0.02);
    }
    
    .footer-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn-secondary {
      padding: 12px 24px;
      border: 1px solid var(--emma-border);
      border-radius: 8px;
      background: transparent;
      color: var(--emma-text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--emma-primary);
    }
    
    .btn-primary {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      background: var(--emma-gradient-1);
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
    }
  </style>
</head>
<body>
  <div class="container fade-in">
    <div class="settings-container">
      <div class="glass-card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <h2 style="margin:0;">Settings</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <span id="save-indicator" style="display:none;padding:4px 8px;border-radius:999px;font-size:12px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.35);color:#22c55e;">Saved ✓</span>
            <button type="button" id="settings-back" class="btn btn-secondary">← Back</button>
            <button type="button" id="settings-close" class="btn">Close</button>
          </div>
        </div>
        <p style="color: var(--emma-text-secondary); margin-bottom: 32px;">
          Customize how Emma captures and manages your AI memories.
        </p>
        
        <!-- MTAP Status -->
        <div class="mtap-status">
          <div class="mtap-icon">🔐</div>
          <div class="mtap-info">
            <h4>MTAP Protocol Active</h4>
            <p>Memory Transport & Access Protocol v1.0 - Secure, federated memory storage</p>
          </div>
          <label class="toggle">
            <input type="checkbox" id="mtap-mode" checked>
            <span class="slider"></span>
          </label>
        </div>
        
        <!-- Emma Orb Selector -->
        <div class="setting-section">
          <h3>✨ Choose Your Emma</h3>
          <p class="section-description">Select your AI companion and customize their appearance</p>
          
          <div class="orb-avatar-selector">
            <div class="orb-option" data-orb-type="default">
              <div class="orb-avatar" id="avatar-default">
                <div class="orb-container"></div>
              </div>
              <div class="orb-info">
                <h4>Emma Assistant</h4>
                <p>Your versatile AI companion for daily tasks and conversations</p>
                <span class="orb-color-indicator">Purple • Classic</span>
              </div>
              <div class="orb-status-badge" id="status-default">Active</div>
            </div>
            
            <div class="orb-option" data-orb-type="dementia">
              <div class="orb-avatar" id="avatar-dementia">
                <div class="orb-container"></div>
              </div>
              <div class="orb-info">
                <h4>Memory Companion</h4>
                <p>Specialized support for memory care with gentle, patient interactions</p>
                <span class="orb-color-indicator">Blue • Calming</span>
              </div>
              <div class="orb-status-badge" id="status-dementia">Configure</div>
            </div>
            
            <div class="orb-option" data-orb-type="mirror">
              <div class="orb-avatar" id="avatar-mirror">
                <div class="orb-container"></div>
              </div>
              <div class="orb-info">
                <h4>Mirror Emma</h4>
                <p>Reflective companion that adapts and mirrors your communication style</p>
                <span class="orb-color-indicator">Silver • Adaptive</span>
              </div>
              <div class="orb-status-badge" id="status-mirror">Configure</div>
            </div>
          </div>
        </div>

        <!-- Dementia Companion Settings -->
        <div class="setting-section">
          <h3>🧠 Dementia Companion</h3>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>Enable Dementia Companion</strong>
              <small>Turn on Emma's dementia-focused experience for this vault</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="dementia-enabled">
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>Support Stage</strong>
              <small>Adjust Emma's responses based on progression</small>
            </div>
            <select id="dementia-stage" class="emma-select" style="width: 120px;">
              <option value="EARLY">Early</option>
              <option value="MIDDLE">Middle</option>
              <option value="LATE">Late</option>
            </select>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>Voice Assistance</strong>
              <small>Enable Emma's voice responses and listening</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="dementia-voice-enabled">
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>Store Transcripts (for Caregivers)</strong>
              <small>Save detailed interaction transcripts for caregiver review (privacy sensitive)</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="dementia-store-transcripts">
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <!-- Capture Settings -->
        <div class="setting-section">
          <h3>Capture Settings</h3>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>Auto-Capture</strong>
              <small>Automatically save conversations from supported sites</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="auto-capture" checked>
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>Capture User Messages</strong>
              <small>Save your messages to AI assistants</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="capture-user" checked>
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>Capture AI Responses</strong>
              <small>Save AI assistant responses</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="capture-ai" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <!-- Storage Management has been unified into Vault Backup & Restore below -->
        
        <!-- Vault Backup & Restore -->
        <div class="setting-section vault-backup-section">
          <div class="vault-section-header">
            <h3>🔐 Memory Vault Management</h3>
            <div class="vault-status-indicator">
              <span id="vault-status-dot" class="status-dot status-loading"></span>
              <span id="vault-status-text">Checking vault...</span>
            </div>
          </div>

          <!-- QR Code Management Section -->
          <div class="backup-action-card qr-management-card" style="grid-column: 1 / -1; margin-bottom: 24px;">
            <div class="action-icon">📱</div>
            <div class="action-content">
              <h4>QR Code Sharing</h4>
              <p>Generate secure QR codes to share your vault with family, AI assistants, or healthcare providers</p>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0;">
                <div class="qr-sharing-option">
                  <h5 style="color: var(--emma-text); margin: 0 0 8px 0; font-size: 14px;">🔐 Vault QR</h5>
                  <p style="color: var(--emma-text-secondary); font-size: 12px; margin: 0 0 12px 0;">Share entire vault with time-limited access</p>
                  <button type="button" id="generate-vault-qr" class="btn btn-primary" style="width: 100%; font-size: 13px;">
                    Generate Vault QR
                  </button>
                </div>
                
                <div class="qr-sharing-option">
                  <h5 style="color: var(--emma-text); margin: 0 0 8px 0; font-size: 14px;">📋 QR Scanner</h5>
                  <p style="color: var(--emma-text-secondary); font-size: 12px; margin: 0 0 12px 0;">Scan QR codes to access shared memories</p>
                  <button type="button" id="open-qr-scanner" class="btn btn-secondary" style="width: 100%; font-size: 13px;">
                    Open Scanner
                  </button>
                </div>
              </div>
              
              <!-- QR Management Options -->
              <details style="margin-top: 16px;">
                <summary style="color: var(--emma-text-secondary); cursor: pointer; font-size: 13px;">
                  ⚙️ QR Management Options
                </summary>
                <div style="margin-top: 12px; padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 6px;">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                      <input type="checkbox" id="qr-default-private" style="margin: 0;">
                      <span style="color: var(--emma-text-secondary);">Default to private QRs</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                      <input type="checkbox" id="qr-auto-expire" checked style="margin: 0;">
                      <span style="color: var(--emma-text-secondary);">Auto-expire QR codes</span>
                    </label>
                  </div>
                  <div style="margin-top: 8px;">
                    <label style="color: var(--emma-text-secondary); font-size: 13px; display: block; margin-bottom: 4px;">
                      Default expiry time:
                    </label>
                    <select id="qr-default-expiry" style="
                      background: rgba(255, 255, 255, 0.1); 
                      border: 1px solid var(--emma-border);
                      color: var(--emma-text); 
                      padding: 4px 8px; 
                      border-radius: 4px; 
                      font-size: 12px;
                    ">
                      <option value="3600000">1 hour</option>
                      <option value="86400000" selected>24 hours</option>
                      <option value="604800000">7 days</option>
                      <option value="2592000000">30 days</option>
                    </select>
                  </div>
                </div>
              </details>
            </div>
          </div>

          <!-- Vault Statistics Card -->
          <div class="vault-stats-card">
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value" id="vault-memory-count">-</div>
                <div class="stat-label">Memories</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="vault-size">-</div>
                <div class="stat-label">Storage Used</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="vault-last-backup">Never</div>
                <div class="stat-label">Last Backup</div>
              </div>
            </div>
          </div>

          <!-- Backup Actions -->
          <div class="backup-actions-grid">
            <div class="backup-action-card export-card">
              <div class="action-icon">📤</div>
              <div class="action-content">
                <h4>Export Vault</h4>
                <p>Create an encrypted backup of your entire memory vault including all memories and attachments</p>
                <button type="button" id="export-vault" class="btn btn-primary">
                  <span class="btn-icon">📤</span> Export Vault
                </button>
              </div>
            </div>

            <div class="backup-action-card import-card">
              <div class="action-icon">📥</div>
              <div class="action-content">
                <h4>Import Vault</h4>
                <p>Restore a vault from an encrypted backup file with a new passphrase</p>
                <input type="file" id="import-vault-file" accept=".json" style="display: none;">
                <button type="button" id="import-vault" class="btn btn-secondary">
                  <span class="btn-icon">📁</span> Choose Backup File
                </button>
              </div>
            </div>
          </div>

          <!-- Status Display -->
          <div id="backup-status" class="backup-status"></div>

          <!-- Vault Information Panel -->
          <div class="vault-info-panel">
            <div class="info-header">
              <h4>🔒 Vault Information</h4>
              <button type="button" id="refresh-vault-info" class="btn-link">
                <span>🔄</span> Refresh
              </button>
            </div>
            <div class="vault-details">
              <div class="detail-row">
                <span class="detail-label">Vault ID:</span>
                <span id="vault-id" class="detail-value">Loading...</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Created:</span>
                <span id="vault-created" class="detail-value">Loading...</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span id="vault-lock-status" class="detail-value">
                  <span class="status-indicator">🔓</span> Unlocked
                </span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Encryption:</span>
                <span class="detail-value">AES-256-GCM</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Legacy Memory Migration -->
        <div class="setting-section migration-section">
          <div class="migration-header">
            <h3>🔄 Legacy Memory Migration</h3>
            <div id="migration-status-indicator" class="migration-status-indicator">
              <span id="migration-status-dot" class="status-dot status-unknown"></span>
              <span id="migration-status-text">Checking for legacy data...</span>
            </div>
          </div>
          
          <p class="migration-description">
            Migrate existing memories from legacy storage to the secure vault system. 
            This ensures all your memories are encrypted and unified in one place.
          </p>

          <!-- Migration Analysis -->
          <div id="migration-analysis" class="migration-analysis" style="display: none;">
            <div class="analysis-summary">
              <div class="analysis-item">
                <span class="analysis-label">Legacy Memories:</span>
                <span id="legacy-count" class="analysis-value">0</span>
              </div>
              <div class="analysis-item">
                <span class="analysis-label">MTAP Memories:</span>
                <span id="mtap-count" class="analysis-value">0</span>
              </div>
              <div class="analysis-item">
                <span class="analysis-label">Total Size:</span>
                <span id="total-size" class="analysis-value">0 B</span>
              </div>
              <div class="analysis-item">
                <span class="analysis-label">Duplicates:</span>
                <span id="duplicate-count" class="analysis-value">0</span>
              </div>
            </div>
          </div>

          <!-- Migration Options -->
          <div id="migration-options" class="migration-options" style="display: none;">
            <h4>Migration Options</h4>
            <div class="option-grid">
              <div class="option-item">
                <label>
                  <input type="checkbox" id="migration-dry-run" checked>
                  <span>Dry Run (Preview Only)</span>
                </label>
                <small>Test migration without actually moving memories</small>
              </div>
              
              <div class="option-item">
                <label>
                  <input type="checkbox" id="migration-skip-duplicates" checked>
                  <span>Skip Duplicates</span>
                </label>
                <small>Don't migrate memories that already exist in vault</small>
              </div>
              
              <div class="option-item">
                <label>
                  <input type="checkbox" id="migration-backup-first" checked>
                  <span>Backup Before Migration</span>
                </label>
                <small>Create vault backup before starting migration</small>
              </div>
            </div>
          </div>

          <!-- Migration Progress -->
          <div id="migration-progress" class="migration-progress" style="display: none;">
            <h4>Migration Progress</h4>
            <div class="progress-info">
              <div id="migration-phase" class="progress-phase">Preparing...</div>
              <div class="progress-bar">
                <div id="migration-progress-fill" class="progress-fill" style="width: 0%"></div>
              </div>
              <div id="migration-percentage" class="progress-percentage">0%</div>
            </div>
          </div>

          <!-- Migration Results -->
          <div id="migration-results" class="migration-results" style="display: none;">
            <h4>Migration Results</h4>
            <div class="results-summary">
              <div class="result-item success">
                <span>Migrated:</span>
                <span id="migrated-count">0</span>
              </div>
              <div class="result-item warning">
                <span>Skipped:</span>
                <span id="skipped-count">0</span>
              </div>
              <div class="result-item error">
                <span>Failed:</span>
                <span id="failed-count">0</span>
              </div>
            </div>
          </div>

          <!-- Migration Actions -->
          <div class="migration-actions">
            <button type="button" id="analyze-legacy-btn" class="btn-secondary">
              <span>📊</span> Analyze Legacy Data
            </button>
            
            <button type="button" id="preview-migration-btn" class="btn-info" style="display: none;">
              <span>🔍</span> Preview Migration
            </button>
            
            <button type="button" id="start-migration-btn" class="btn-primary" style="display: none;">
              <span>🚀</span> Start Migration
            </button>
            
            <button type="button" id="refresh-migration-btn" class="btn-secondary" style="display: none;">
              <span>🔄</span> Refresh Status
            </button>
          </div>

          <!-- Migration Status Display -->
          <div id="migration-status" class="migration-status"></div>
        </div>
        
        <!-- Privacy Settings -->
        <div class="setting-section">
          <h3>Privacy & Security</h3>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>MTAP Protocol</strong>
              <small>Memory Transport & Access Protocol for secure federated storage</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="mtap-toggle" checked>
              <span class="slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <div class="setting-label">
              <strong>Local Storage Only</strong>
              <small>All data stays on your device - no cloud uploads</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="local-only" checked disabled>
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>Analytics</strong>
              <small>Collect anonymous usage statistics (currently disabled)</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="analytics" disabled>
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <strong>Debug Mode</strong>
              <small>Show detailed console logs for troubleshooting</small>
            </div>
            <label class="toggle">
              <input type="checkbox" id="debug-mode">
              <span class="slider"></span>
            </label>
          </div>
        </div>

        
        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px; margin-top: 32px;">
          <button id="save-btn" class="btn">
            Save Settings
          </button>
          <button id="reset-btn" class="btn btn-secondary">
            Reset to Defaults
          </button>
        </div>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 48px; color: var(--emma-text-tertiary);">
      <p>Emma v1.1.0 | <a href="privacy.html" style="color: var(--emma-purple);">Privacy Policy</a></p>
    </div>
  </div>

  <div class="notification" id="notification"></div>
  <input type="file" id="import-file" accept=".json" style="display: none;">

  <!-- Password Modal (from popup.html) -->
  <div id="password-modal" class="password-modal" style="display: none;">
    <div class="password-modal-content">
      <div class="password-modal-header">
        <h3 id="password-modal-title">Enter Vault Code</h3>
        <button type="button" id="password-modal-close" class="password-modal-close">×</button>
      </div>
      <div class="password-modal-body">
        <input 
          type="password" 
          id="password-modal-input" 
          class="password-modal-input"
          placeholder="•••••••••"
          autocomplete="current-password"
        >
        <div class="password-modal-actions">
          <button type="button" id="password-modal-cancel" class="btn-secondary">Cancel</button>
          <button type="button" id="password-modal-confirm" class="btn-primary">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Orb Settings Dialog -->
  <div id="orb-settings-dialog" class="modal-overlay">
    <div class="orb-dialog">
      <div class="orb-dialog-header">
        <div class="orb-dialog-title">
          <div class="dialog-orb-preview" id="dialog-orb-preview">
            <div class="orb-container"></div>
          </div>
          <div class="title-text">
            <h3 id="dialog-orb-title">Emma Assistant</h3>
            <p id="dialog-orb-subtitle">Customize your AI companion</p>
          </div>
        </div>
        <button class="dialog-close" id="close-orb-dialog">&times;</button>
      </div>
      
      <div class="orb-dialog-content">
        <div class="dialog-tabs">
          <button class="tab-button active" data-tab="appearance">Appearance</button>
          <button class="tab-button" data-tab="behavior">Behavior</button>
          <button class="tab-button" data-tab="advanced">Advanced</button>
        </div>
        
        <!-- Appearance Tab -->
        <div class="tab-content active" id="tab-appearance">
          <div class="setting-group">
            <h4>🎨 Visual Style</h4>
            
            <div class="setting-row">
              <label>Color Theme</label>
              <div class="color-theme-selector">
                <div class="color-option active" data-color="default" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed)"></div>
                <div class="color-option" data-color="blue" style="background: linear-gradient(135deg, #3b82f6, #2563eb)"></div>
                <div class="color-option" data-color="green" style="background: linear-gradient(135deg, #10b981, #059669)"></div>
                <div class="color-option" data-color="orange" style="background: linear-gradient(135deg, #f59e0b, #d97706)"></div>
                <div class="color-option" data-color="pink" style="background: linear-gradient(135deg, #ec4899, #db2777)"></div>
                <div class="color-option" data-color="custom" style="background: linear-gradient(45deg, #333, #666)">
                  <span>+</span>
                </div>
              </div>
              <input type="color" id="dialog-custom-color" value="#8b5cf6" style="display: none;">
            </div>
            
            <div class="setting-row">
              <label>Size</label>
              <div class="size-control">
                <input type="range" id="dialog-orb-size" min="48" max="120" value="72" step="8">
                <span id="dialog-size-value">72px</span>
              </div>
            </div>
            
            <div class="setting-row">
              <label>Position</label>
              <div class="position-grid">
                <div class="position-option" data-position="top-left">
                  <div class="position-preview">
                    <div class="mini-orb top-left"></div>
                  </div>
                  <span>Top Left</span>
                </div>
                <div class="position-option" data-position="top-right">
                  <div class="position-preview">
                    <div class="mini-orb top-right"></div>
                  </div>
                  <span>Top Right</span>
                </div>
                <div class="position-option active" data-position="bottom-left">
                  <div class="position-preview">
                    <div class="mini-orb bottom-left"></div>
                  </div>
                  <span>Bottom Left</span>
                </div>
                <div class="position-option" data-position="bottom-right">
                  <div class="position-preview">
                    <div class="mini-orb bottom-right"></div>
                  </div>
                  <span>Bottom Right</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="setting-group">
            <h4>✨ Effects</h4>
            
            <div class="setting-row">
              <div class="toggle-setting">
                <label>Glow Effect</label>
                <label class="toggle">
                  <input type="checkbox" id="dialog-glow-effect" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            
            <div class="setting-row">
              <div class="toggle-setting">
                <label>Hover Animation</label>
                <label class="toggle">
                  <input type="checkbox" id="dialog-hover-animation" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            
            <div class="setting-row">
              <div class="toggle-setting">
                <label>Auto-hide (inactive)</label>
                <label class="toggle">
                  <input type="checkbox" id="dialog-auto-hide">
                  <span class="slider"></span>
                </label>
              </div>
              <div class="sub-setting" id="dialog-auto-hide-options" style="display: none;">
                <label>Hide after</label>
                <input type="number" id="dialog-hide-minutes" min="1" max="60" value="5">
                <span>minutes</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Behavior Tab -->
        <div class="tab-content" id="tab-behavior">
          <div class="setting-group">
            <h4>🗣️ Voice & Communication</h4>
            
            <div class="setting-row">
              <div class="toggle-setting">
                <label>Voice Responses</label>
                <label class="toggle">
                  <input type="checkbox" id="dialog-voice-enabled">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            
            <div class="setting-row">
              <label>Response Style</label>
              <select id="dialog-response-style" class="emma-select">
                <option value="conversational">Conversational</option>
                <option value="professional">Professional</option>
                <option value="casual">Casual</option>
                <option value="supportive">Supportive</option>
              </select>
            </div>
            
            <div class="setting-row">
              <label>Wake Word</label>
              <input type="text" id="dialog-wake-word" value="Emma" class="text-input">
            </div>
          </div>
          
          <div class="setting-group" id="dementia-specific" style="display: none;">
            <h4>🧠 Memory Support</h4>
            
            <div class="setting-row">
              <label>Support Level</label>
              <select id="dialog-dementia-stage" class="emma-select">
                <option value="EARLY">Early Stage</option>
                <option value="MIDDLE">Middle Stage</option>
                <option value="LATE">Late Stage</option>
              </select>
            </div>
            
            <div class="setting-row">
              <div class="toggle-setting">
                <label>Store Conversation Transcripts</label>
                <label class="toggle">
                  <input type="checkbox" id="dialog-store-transcripts">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="setting-group" id="mirror-specific" style="display: none;">
            <h4>🪞 Adaptive Behavior</h4>
            
            <div class="setting-row">
              <label>Adaptation Speed</label>
              <input type="range" id="dialog-adaptation-speed" min="1" max="10" value="5">
            </div>
            
            <div class="setting-row">
              <div class="toggle-setting">
                <label>Mirror Communication Style</label>
                <label class="toggle">
                  <input type="checkbox" id="dialog-mirror-style" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Advanced Tab -->
        <div class="tab-content" id="tab-advanced">
          <div class="setting-group">
            <h4>⚙️ Technical Settings</h4>
            
            <div class="setting-row">
              <label>Processing Mode</label>
              <select id="dialog-processing-mode" class="emma-select">
                <option value="local">Local Only</option>
                <option value="hybrid">Hybrid</option>
                <option value="cloud">Cloud Enhanced</option>
              </select>
            </div>
            
            <div class="setting-row">
              <label>Response Delay</label>
              <input type="range" id="dialog-response-delay" min="0" max="5000" value="1000" step="100">
              <span id="dialog-delay-value">1.0s</span>
            </div>
            
            <div class="setting-row">
              <div class="toggle-setting">
                <label>Debug Mode</label>
                <label class="toggle">
                  <input type="checkbox" id="dialog-debug-mode">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="setting-group">
            <h4>🔒 Privacy & Data</h4>
            
            <div class="setting-row">
              <div class="toggle-setting">
                <label>Local Processing Only</label>
                <label class="toggle">
                  <input type="checkbox" id="dialog-local-only" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            
            <div class="setting-row">
              <div class="toggle-setting">
                <label>Encrypted Storage</label>
                <label class="toggle">
                  <input type="checkbox" id="dialog-encrypted-storage" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="orb-dialog-footer">
        <button class="btn-secondary" id="dialog-reset">Reset to Defaults</button>
        <div class="footer-actions">
          <button class="btn-secondary" id="dialog-cancel">Cancel</button>
          <button class="btn-primary" id="dialog-save">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Home Navigation Button -->
  <button id="home-nav-button" class="home-nav-button" title="Return to Dashboard" aria-label="Return to Dashboard" onclick="window.location.href='../working-desktop-dashboard.html'" style="
    position: fixed;
    bottom: 24px;
    left: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 32px rgba(118, 75, 162, 0.3);
    transition: all 0.3s ease;
    z-index: 1000;
  " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
    🏠
  </button>

  <!-- Universal Emma Orb System - Direct Loading for Extension Pages -->
  <!-- Web Vault System Scripts -->
  <script src="../js/emma-input-modal.js"></script>
  <script src="../js/clean-password-modal.js"></script>
  <script src="../js/emma-web-vault.js"></script>
  <script src="../js/web-vault-status.js"></script>
  
  <script src="../js/emma-orb.js"></script>
  <script src="../js/settings-service.js"></script> 
  <script src="../js/orb-experience-manager.js"></script>
  <script src="../js/experience-popup-base.js"></script>
  <script src="../js/assistant-experience-popup.js"></script>
  <script src="../js/dementia-experience-popup.js"></script>
  <script src="../js/mirror-experience-popup.js"></script>
  <script src="../js/universal-emma-orb.js"></script>
  
  <!-- Initialize Universal Orb for Extension Page -->
  <script>
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // CRITICAL: Initialize vault system for options page
        console.log('⚙️ OPTIONS: Initializing vault system...');
        
        // Initialize vault objects if they don't exist
        if (!window.emmaWebVault && typeof EmmaWebVault !== 'undefined') {
          window.emmaWebVault = new EmmaWebVault();
          console.log('✅ OPTIONS: EmmaWebVault created');
        }
        
        if (!window.webVaultStatus && typeof WebVaultStatus !== 'undefined') {
          window.webVaultStatus = new WebVaultStatus();
          console.log('✅ OPTIONS: WebVaultStatus created');
        }
        
        // ELEGANT: Restore complete vault state if session is active
        if (sessionStorage.getItem('emmaVaultActive') === 'true' && window.emmaWebVault) {
          (async () => {
            try {
              console.log('🔄 OPTIONS: Restoring elegant vault state...');
              const result = await window.emmaWebVault.restoreVaultState();
              if (result) {
                console.log('✅ OPTIONS: Vault state restored successfully');
                console.log('📊 OPTIONS: Passphrase available:', result.hasPassphrase);
                console.log('📁 OPTIONS: Filename available:', result.hasFileName);
                // If in fallback mode, show affordance to re-enable direct save
                try {
                  if (window.emmaWebVault && window.emmaWebVault.isFallbackMode && window.emmaWebVault.isFallbackMode()) {
                    window.emmaWebVault.showDirectSaveAffordance && window.emmaWebVault.showDirectSaveAffordance();
                  }
                } catch (_) {}
              } else {
                console.log('🔒 OPTIONS: Vault session is locked or invalid');
              }
            } catch (error) {
              console.warn('⚠️ OPTIONS: Could not restore vault state:', error);
            }
          })();
        }
        setTimeout(() => window.UniversalEmmaOrb.initialize(), 100);
      });
    } else {
      setTimeout(() => window.UniversalEmmaOrb.initialize(), 100);
    }
  </script>
  
  <script src="../js/options.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emma Settings - Your Intelligent Memory Companion</title>
  
  <!-- Emma Core Systems -->
  <script src="../js/emma-input-modal.js"></script>
  <script src="../js/clean-password-modal.js"></script>
  <script src="../js/emma-web-vault.js"></script>
  
  <!-- Browser Compatibility Layer -->
  <script src="../emma-browser-compatibility-fix.js"></script>
  
  <!-- Mobile UI Fixes -->
  <script src="../emma-mobile-ui-fixes.js"></script>
  
  <style>
    /* Emma Brand Variables */
    :root {
      --emma-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      --emma-purple: #8B5CF6;
      --emma-pink: #F093FB;
      --emma-glow: 0 0 40px rgba(134, 88, 255, 0.6);
      --emma-glass: rgba(255, 255, 255, 0.1);
      --emma-border: rgba(255, 255, 255, 0.2);
      --emma-text: #ffffff;
      --emma-text-secondary: rgba(255, 255, 255, 0.8);
      --emma-text-tertiary: rgba(255, 255, 255, 0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--emma-gradient);
      color: var(--emma-text);
      min-height: 100vh;
      padding: 20px;
    }

    .settings-container {
      max-width: 800px;
      margin: 0 auto;
      position: relative;
    }

    .settings-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .emma-logo {
      font-size: 48px;
      font-weight: 300;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--emma-purple), var(--emma-pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .settings-subtitle {
      font-size: 18px;
      color: var(--emma-text-secondary);
      margin-bottom: 12px;
    }

    .back-button {
      position: absolute;
      top: -10px;
      left: 0;
      background: var(--emma-glass);
      border: 2px solid var(--emma-border);
      color: var(--emma-text);
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .settings-section {
      background: var(--emma-glass);
      backdrop-filter: blur(20px);
      border: 2px solid var(--emma-border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: 0 8px 32px rgba(139, 92, 246, 0.2);
    }

    .section-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--emma-text);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-description {
      font-size: 16px;
      color: var(--emma-text-secondary);
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .setting-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .setting-label {
      flex: 1;
    }

    .setting-label strong {
      display: block;
      color: var(--emma-text);
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 16px;
    }

    .setting-label span {
      color: var(--emma-text-secondary);
      font-size: 14px;
      line-height: 1.4;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.2);
      transition: 0.4s;
      border-radius: 30px;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input:checked + .toggle-slider {
      background: linear-gradient(135deg, var(--emma-purple), var(--emma-pink));
      border-color: var(--emma-purple);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }

    .api-key-input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--emma-text);
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
    }

    .api-key-input:focus {
      border-color: var(--emma-purple);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }

    .api-key-input::placeholder {
      color: var(--emma-text-tertiary);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #6b7280;
      transition: all 0.3s ease;
    }

    .status-dot.active {
      background: var(--emma-purple);
      box-shadow: 0 0 12px rgba(139, 92, 246, 0.6);
    }

    .save-button {
      background: linear-gradient(135deg, var(--emma-purple), var(--emma-pink));
      border: none;
      color: white;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 32px;
    }

    .save-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
    }

    .help-text {
      font-size: 13px;
      color: var(--emma-text-tertiary);
      margin-top: 8px;
      line-height: 1.4;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      .settings-section {
        padding: 24px 20px;
        margin-bottom: 24px;
      }

      .section-title {
        font-size: 20px;
      }

      .setting-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
        padding: 16px 0;
      }

      .toggle-switch {
        align-self: flex-end;
      }

      .back-button {
        position: static;
        margin-bottom: 20px;
        align-self: flex-start;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .settings-section {
      animation: fadeIn 0.6s ease;
    }

    .settings-section:nth-child(2) { animation-delay: 0.1s; }
    .settings-section:nth-child(3) { animation-delay: 0.2s; }
    .settings-section:nth-child(4) { animation-delay: 0.3s; }

    /* High Contrast Mode */
    body.high-contrast {
      --emma-gradient: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #333333 100%);
      --emma-glass: rgba(255, 255, 255, 0.2);
      --emma-border: rgba(255, 255, 255, 0.5);
      --emma-text: #ffffff;
    }
    
    body.high-contrast .settings-section {
      border: 2px solid rgba(255, 255, 255, 0.5);
    }
    
    body.high-contrast .toggle-switch .toggle-slider {
      border: 2px solid rgba(255, 255, 255, 0.7);
    }
  </style>
</head>
<body>
  <div class="settings-container">
    <a href="../dashboard.html" class="back-button">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m12 19-7-7 7-7"/>
        <path d="m19 12H5"/>
      </svg>
      Back to Emma
    </a>

    <div class="settings-header">
      <h1 class="emma-logo">emma</h1>
      <p class="settings-subtitle">Configure your intelligent memory companion</p>
    </div>

    <!-- AI Configuration -->
    <div class="settings-section">
      <h2 class="section-title">
        🧠 Artificial Intelligence
      </h2>
      <p class="section-description">
        Emma's AI works beautifully offline with intelligent heuristics. For even more advanced understanding and nuanced conversations, connect your OpenAI API key to unlock Emma's full potential.
      </p>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>OpenAI API Key</strong>
          <span>Enable Emma's most advanced AI responses with your OpenAI API key. Emma works great offline with smart heuristics, but an API key unlocks deeper understanding and more nuanced conversations.</span>
        </div>
        <input 
          type="password" 
          id="api-key-input" 
          class="api-key-input"
          placeholder="sk-proj-..." 
          autocomplete="off"
          style="
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            min-width: 280px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 14px;
            margin-top: 8px;
          "
        >
      </div>
      <div class="help-text" style="margin-top: 8px;">
        🔒 Your API key is stored locally and never transmitted to our servers. <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--emma-pink);">Get your API key here</a>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Memory Detection</strong>
          <span>Emma automatically recognizes when you're sharing meaningful memories and gently suggests saving them to your vault.</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="memory-detection-toggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>People Recognition</strong>
          <span>Emma identifies names mentioned in conversations and connects them to people in your vault or suggests adding new ones.</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="people-recognition-toggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Vectorless AI Status</strong>
          <span>Real-time status of Emma's intelligent memory processing system.</span>
        </div>
        <div class="status-indicator">
          <div class="status-dot" id="ai-status-dot"></div>
          <span id="ai-status-text">Initializing...</span>
        </div>
      </div>
    </div>

    <!-- Memory & Care -->
    <div class="settings-section">
      <h2 class="section-title">
        💜 Memory & Care
      </h2>
      <p class="section-description">
        Specialized features for memory preservation and dementia care support.
      </p>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Dementia Care Mode</strong>
          <span>Enables validation therapy principles and specialized responses for users with memory impairment. Designed with love for Debbe.</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="dementia-mode-toggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Memory Auto-Capture</strong>
          <span>Automatically detect and suggest capturing meaningful moments during conversations.</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="auto-capture-toggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <!-- Privacy & Security -->
    <div class="settings-section">
      <h2 class="section-title">
        🔒 Privacy & Security
      </h2>
      <p class="section-description">
        Emma prioritizes your privacy with local-only processing and secure vault encryption.
      </p>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Local Processing</strong>
          <span>All memory analysis happens on your device. No data is sent to external servers.</span>
        </div>
        <div class="status-indicator">
          <div class="status-dot active"></div>
          <span>Always Enabled</span>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Vault Encryption</strong>
          <span>Your .emma files are protected with AES-256 encryption and PBKDF2 key derivation.</span>
        </div>
        <div class="status-indicator">
          <div class="status-dot active"></div>
          <span>Always Enabled</span>
        </div>
      </div>
    </div>

    <!-- Dementia Care & Accessibility -->
    <div class="settings-section">
      <h2 class="section-title">
        ❤️ Dementia Care & Accessibility
      </h2>
      <p class="section-description">
        Specialized features designed for users with memory impairment and their caregivers. Emma adapts to provide gentle, supportive interactions.
      </p>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Font Size</strong>
          <span>Adjust text size throughout Emma for better readability. Larger fonts reduce eye strain and improve accessibility.</span>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button id="decrease-font" style="
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">−</button>
          <span id="font-size-display" style="min-width: 80px; text-align: center; font-weight: 600;">100%</span>
          <button id="increase-font" style="
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">+</button>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Reduced Motion</strong>
          <span>Minimize animations and transitions to reduce disorientation. Helpful for users sensitive to visual motion.</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="reduced-motion-toggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>High Contrast Mode</strong>
          <span>Increase color contrast for better visibility. Makes text and interface elements easier to distinguish.</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="high-contrast-toggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Gentle Reminders</strong>
          <span>Emma uses encouraging language and avoids correcting or contradicting. Based on validation therapy principles.</span>
        </div>
        <div class="status-indicator">
          <div class="status-dot active"></div>
          <span>Always Enabled</span>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Repetition Tolerance</strong>
          <span>Emma patiently handles repeated questions without highlighting repetition. Maintains dignity and reduces anxiety.</span>
        </div>
        <div class="status-indicator">
          <div class="status-dot active"></div>
          <span>Always Enabled</span>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Response Pacing</strong>
          <span>Emma waits 2-3 seconds before responding to reduce pressure and allow processing time.</span>
        </div>
        <div class="status-indicator">
          <div class="status-dot active"></div>
          <span>Always Enabled</span>
        </div>
      </div>
    </div>

    <!-- System Information -->
    <div class="settings-section">
      <h2 class="section-title">
        ℹ️ System Information
      </h2>
      <p class="section-description">
        Basic system information and compatibility status.
      </p>
      
      <div class="setting-item">
        <div class="setting-label">
          <strong>Emma Version</strong>
          <span>Current version of Emma and compatibility information.</span>
        </div>
        <div class="status-indicator">
          <div class="status-dot active"></div>
          <span>v1.0 Beta</span>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <button class="save-button" id="save-all-settings">
      ✨ Save All Settings
    </button>
  </div>

  <script>
    /**
     * Emma Settings Manager
     * Clean, modern settings interface with Emma branding
     */
    class EmmaSettingsManager {
      constructor() {
        this.settings = {};
        this.loadSettings();
        this.setupEventListeners();
        this.updateUI();
        
        console.log('⚙️ Emma Settings Manager initialized');
      }
      
      loadSettings() {
        try {
          // Load from localStorage
          const saved = localStorage.getItem('emmaSettings');
          this.settings = saved ? JSON.parse(saved) : {
            apiKey: '',
            memoryDetection: true,
            peopleRecognition: true,
            fontSize: 100,
            reducedMotion: false,
            highContrast: false
          };
          
          console.log('⚙️ Settings loaded:', this.settings);
        } catch (error) {
          console.error('⚙️ Failed to load settings:', error);
          this.settings = {
            apiKey: '',
            memoryDetection: true,
            peopleRecognition: true,
            fontSize: 100,
            reducedMotion: false,
            highContrast: false
          };
        }
      }
      
      saveSettings() {
        try {
          localStorage.setItem('emmaSettings', JSON.stringify(this.settings));
          console.log('⚙️ Settings saved:', this.settings);
          this.showToast('✅ Settings saved successfully!', 'success');
        } catch (error) {
          console.error('⚙️ Failed to save settings:', error);
          this.showToast('❌ Failed to save settings', 'error');
        }
      }
      
      updateUI() {
        // Update API key input
        const apiKeyInput = document.getElementById('api-key-input');
        if (apiKeyInput) apiKeyInput.value = this.settings.apiKey || '';
        
        // Update toggle elements
        const memoryToggle = document.getElementById('memory-detection-toggle');
        const peopleToggle = document.getElementById('people-recognition-toggle');
        const reducedMotionToggle = document.getElementById('reduced-motion-toggle');
        const highContrastToggle = document.getElementById('high-contrast-toggle');
        
        if (memoryToggle) memoryToggle.checked = this.settings.memoryDetection !== false;
        if (peopleToggle) peopleToggle.checked = this.settings.peopleRecognition !== false;
        if (reducedMotionToggle) reducedMotionToggle.checked = this.settings.reducedMotion || false;
        if (highContrastToggle) highContrastToggle.checked = this.settings.highContrast || false;
        
        // Update font size
        this.updateFontSize();
        
        // Update AI status
        this.updateAIStatus();
      }
      
      updateAIStatus() {
        const statusDot = document.getElementById('ai-status-dot');
        const statusText = document.getElementById('ai-status-text');
        
        if (this.settings.apiKey && this.settings.apiKey.startsWith('sk-')) {
          statusDot.classList.add('active');
          statusText.textContent = 'Enhanced AI Mode (OpenAI)';
        } else {
          statusDot.classList.remove('active');
          statusText.textContent = 'Intelligent Offline Mode';
        }
      }
      
      setupEventListeners() {
        // API Key input
        const apiKeyInput = document.getElementById('api-key-input');
        if (apiKeyInput) {
          apiKeyInput.addEventListener('input', (e) => {
            this.settings.apiKey = e.target.value.trim();
            this.updateAIStatus();
          });
        }
        
        // Toggle switches
        const memoryToggle = document.getElementById('memory-detection-toggle');
        const peopleToggle = document.getElementById('people-recognition-toggle');
        const reducedMotionToggle = document.getElementById('reduced-motion-toggle');
        const highContrastToggle = document.getElementById('high-contrast-toggle');
        
        if (memoryToggle) {
          memoryToggle.addEventListener('change', (e) => {
            this.settings.memoryDetection = e.target.checked;
          });
        }
        
        if (peopleToggle) {
          peopleToggle.addEventListener('change', (e) => {
            this.settings.peopleRecognition = e.target.checked;
          });
        }
        
        if (reducedMotionToggle) {
          reducedMotionToggle.addEventListener('change', (e) => {
            this.settings.reducedMotion = e.target.checked;
            this.applyAccessibilitySettings();
          });
        }
        
        if (highContrastToggle) {
          highContrastToggle.addEventListener('change', (e) => {
            this.settings.highContrast = e.target.checked;
            this.applyAccessibilitySettings();
          });
        }
        
        // Font size controls
        const decreaseFont = document.getElementById('decrease-font');
        const increaseFont = document.getElementById('increase-font');
        
        if (decreaseFont) {
          decreaseFont.addEventListener('click', () => {
            this.changeFontSize(-10);
          });
        }
        
        if (increaseFont) {
          increaseFont.addEventListener('click', () => {
            this.changeFontSize(10);
          });
        }
        
        // Save button
        document.getElementById('save-all-settings').addEventListener('click', () => {
          this.saveSettings();
        });
        
        // Auto-save on changes
        document.addEventListener('change', () => {
          setTimeout(() => this.saveSettings(), 500);
        });
      }
      
      changeFontSize(delta) {
        this.settings.fontSize = Math.max(80, Math.min(140, this.settings.fontSize + delta));
        this.updateFontSize();
        
        // Apply to Emma Font Scaler if available
        if (window.EmmaFontScaler) {
          window.EmmaFontScaler.setFontSize(this.settings.fontSize);
        }
      }
      
      updateFontSize() {
        const display = document.getElementById('font-size-display');
        if (display) {
          display.textContent = `${this.settings.fontSize}%`;
        }
        
        // Apply font scaling to document
        document.documentElement.style.fontSize = `${this.settings.fontSize}%`;
      }
      
      applyAccessibilitySettings() {
        // Apply reduced motion
        if (this.settings.reducedMotion) {
          document.documentElement.style.setProperty('--emma-motion', 'none');
        } else {
          document.documentElement.style.removeProperty('--emma-motion');
        }
        
        // Apply high contrast
        if (this.settings.highContrast) {
          document.body.classList.add('high-contrast');
        } else {
          document.body.classList.remove('high-contrast');
        }
      }
      
      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? 'rgba(16, 185, 129, 0.9)' : type === 'error' ? 'rgba(239, 68, 68, 0.9)' : 'rgba(59, 130, 246, 0.9)'};
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          font-weight: 600;
          z-index: 10000;
          backdrop-filter: blur(10px);
          border: 2px solid rgba(255, 255, 255, 0.2);
          transform: translateX(100%);
          transition: transform 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.style.transform = 'translateX(0)', 100);
        setTimeout(() => {
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      window.emmaSettingsManager = new EmmaSettingsManager();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emma Dementia Companion - Vault Integration Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 18px;
    }
    
    .demo-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
    }
    
    .main-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .sidebar-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .vault-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: #E3F2FD;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4CAF50;
    }
    
    .status-indicator.locked {
      background: #F44336;
    }
    
    .memory-viewer {
      min-height: 400px;
      background: #f9f9f9;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    .memory-viewer.has-memory {
      padding: 0;
      background: #000;
    }
    
    .memory-image {
      width: 100%;
      height: 400px;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .memory-details {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      color: white;
      padding: 30px 20px 20px;
      border-radius: 0 0 8px 8px;
    }
    
    .memory-caption {
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .memory-metadata {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .memory-nav {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      gap: 15px;
    }
    
    .nav-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: #2196F3;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .nav-btn:hover:not(:disabled) {
      background: #1976D2;
    }
    
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .conversation-log {
      max-height: 300px;
      overflow-y: auto;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .log-entry {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    
    .log-entry:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .log-user {
      color: #2196F3;
      font-weight: 500;
    }
    
    .log-emma {
      color: #4CAF50;
      font-weight: 500;
    }
    
    .log-time {
      font-size: 12px;
      color: #999;
      float: right;
    }
    
    .patterns-display {
      display: grid;
      gap: 10px;
    }
    
    .pattern-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .pattern-label {
      color: #666;
    }
    
    .pattern-value {
      font-weight: 500;
      color: #333;
    }
    
    .setup-prompt {
      text-align: center;
      padding: 60px 20px;
    }
    
    .setup-prompt h3 {
      color: #666;
      margin-bottom: 20px;
    }
    
    .btn-primary {
      padding: 12px 24px;
      border: none;
      background: #2196F3;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary:hover {
      background: #1976D2;
    }
    
    .emma-orb-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 72px;
      height: 72px;
      cursor: pointer;
      z-index: 10000;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2196F3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .instructions {
      background: #FFF3E0;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #FFE0B2;
    }
    
    .instructions h4 {
      margin-top: 0;
      color: #E65100;
    }
    
    @media (max-width: 1024px) {
      .demo-grid {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        grid-row: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Emma Dementia Companion - Live Vault Integration</h1>
    <p class="subtitle">Experience how Emma helps your loved one interact with their memories</p>
    
    <div class="instructions">
      <h4>üîí Setup Required</h4>
      <p>This demo requires an unlocked Emma vault. If you haven't set up a vault yet, click "Initialize Demo Vault" below.</p>
      <p>Once your vault is unlocked, Emma will help navigate through memories with voice assistance.</p>
    </div>
    
    <div class="demo-grid">
      <div class="main-section">
        <div class="vault-status">
          <span class="status-indicator" id="vault-indicator"></span>
          <span id="vault-status-text">Checking vault status...</span>
        </div>
        
        <div id="memory-container">
          <div class="setup-prompt" id="setup-prompt">
            <h3>No Vault Detected</h3>
            <p>To experience the full Dementia Companion, we need to set up a secure memory vault.</p>
            <button class="btn-primary" onclick="initializeDemoVault()">Initialize Demo Vault</button>
          </div>
          
          <div id="memory-viewer-container" style="display: none;">
            <div class="memory-viewer" id="memory-viewer">
              <p>Loading memories...</p>
            </div>
            
            <div class="memory-nav">
              <button class="nav-btn" id="prev-btn" onclick="navigateMemory(-1)" disabled>
                ‚Üê Previous Memory
              </button>
              <button class="nav-btn" id="next-btn" onclick="navigateMemory(1)" disabled>
                Next Memory ‚Üí
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar">
        <div class="sidebar-section">
          <h3>Conversation Log</h3>
          <div class="conversation-log" id="conversation-log">
            <p style="color: #999; text-align: center;">Interactions will appear here...</p>
          </div>
        </div>
        
        <div class="sidebar-section">
          <h3>Pattern Recognition</h3>
          <div class="patterns-display" id="patterns-display">
            <div class="pattern-item">
              <span class="pattern-label">Repeated Questions:</span>
              <span class="pattern-value" id="pattern-repetitions">0</span>
            </div>
            <div class="pattern-item">
              <span class="pattern-label">Engagement Time:</span>
              <span class="pattern-value" id="pattern-engagement">0 min</span>
            </div>
            <div class="pattern-item">
              <span class="pattern-label">Memory Updates:</span>
              <span class="pattern-value" id="pattern-updates">0</span>
            </div>
            <div class="pattern-item">
              <span class="pattern-label">Emotional State:</span>
              <span class="pattern-value" id="pattern-emotion">Neutral</span>
            </div>
          </div>
        </div>
        
        <div class="sidebar-section">
          <h3>Quick Actions</h3>
          <button class="btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="showCaregiverReport()">
            View Caregiver Report
          </button>
          <button class="btn-primary" style="width: 100%;" onclick="addDemoMemories()">
            Add Demo Memories
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Emma Orb Container -->
  <div class="emma-orb-container" id="emma-orb"></div>
  
  <!-- Caregiver Report Modal -->
  <div id="caregiver-report" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10002;">
    <div style="background: white; margin: 50px auto; max-width: 800px; padding: 30px; border-radius: 12px; max-height: 80vh; overflow-y: auto;">
      <h2>Caregiver Report</h2>
      <div id="report-content"></div>
      <button class="btn-primary" onclick="closeCaregiverReport()" style="margin-top: 20px;">Close</button>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="../js/emma-orb.js"></script>
  
  <!-- CTO Intelligence Enhancement: Load intelligent components -->
  <script src="../js/memory-context-analyzer.js"></script>
  <script src="../js/emma-question-engine.js"></script>
  
  <script src="../js/emma-dementia-companion.js"></script>
  <script src="../js/emma-dementia-vault-integration.js"></script>
  <script>
    let companion;
    let memories = [];
    let currentMemoryIndex = 0;
    let sessionStart = Date.now();
    let updateCount = 0;
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', async () => {
      await checkVaultStatus();
      initializeCompanion();
    });
    
    async function checkVaultStatus() {
      try {
        const status = await window.emmaAPI.vault.status();
        updateVaultStatus(status);
        
        if (status.initialized && status.isUnlocked) {
          showMemoryViewer();
          await loadMemories();
        } else {
          showSetupPrompt();
        }
      } catch (error) {
        console.error('Failed to check vault status:', error);
        updateVaultStatus({ initialized: false, isUnlocked: false });
        showSetupPrompt();
      }
    }
    
    function updateVaultStatus(status) {
      const indicator = document.getElementById('vault-indicator');
      const statusText = document.getElementById('vault-status-text');
      
      if (status.isUnlocked) {
        indicator.classList.remove('locked');
        statusText.textContent = 'Vault Unlocked - Ready for memories';
      } else if (status.initialized) {
        indicator.classList.add('locked');
        statusText.textContent = 'Vault Locked - Please unlock to continue';
      } else {
        indicator.classList.add('locked');
        statusText.textContent = 'No Vault - Initialize to begin';
      }
    }
    
    function showSetupPrompt() {
      document.getElementById('setup-prompt').style.display = 'block';
      document.getElementById('memory-viewer-container').style.display = 'none';
    }
    
    function showMemoryViewer() {
      document.getElementById('setup-prompt').style.display = 'none';
      document.getElementById('memory-viewer-container').style.display = 'block';
    }
    
    async function initializeDemoVault() {
      try {
        const result = await window.emmaAPI.vault.initialize({
          passphrase: 'demo-dementia-companion-2024',
          name: 'Dementia Care Vault'
        });
        
        if (result.success) {
          alert('Demo vault created successfully!');
          await checkVaultStatus();
        }
      } catch (error) {
        console.error('Failed to initialize vault:', error);
        alert('Failed to create demo vault. Please check console for details.');
      }
    }
    
    async function loadMemories() {
      const viewer = document.getElementById('memory-viewer');
      viewer.innerHTML = '<span class="loading"></span> Loading memories...';
      
      try {
        // Load memories through the companion's vault integration
        if (companion && companion.vault) {
          memories = await companion.loadMemoriesForViewing();
        } else {
          // Fallback to direct API
          const capsules = await window.emmaAPI.vault.listCapsules();
          memories = capsules.filter(m => 
            ['photo', 'image'].includes(m.semantic?.type || m.metadata?.type)
          );
        }
        
        if (memories.length > 0) {
          displayMemory(0);
          updateNavigation();
        } else {
          viewer.innerHTML = `
            <div style="padding: 60px 20px; color: #666;">
              <h3>No Memories Found</h3>
              <p>Add some demo memories to get started.</p>
              <button class="btn-primary" onclick="addDemoMemories()">Add Demo Memories</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load memories:', error);
        viewer.innerHTML = '<p style="color: #F44336;">Failed to load memories</p>';
      }
    }
    
    async function displayMemory(index) {
      if (index < 0 || index >= memories.length) return;
      
      currentMemoryIndex = index;
      const memory = memories[index];
      const viewer = document.getElementById('memory-viewer');
      
      viewer.classList.add('has-memory');
      
      // For demo, use placeholder images
      const placeholderImages = [
        'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="800" height="400"%3E%3Crect fill="%23E3F2FD" width="800" height="400"/%3E%3Ctext x="400" y="200" text-anchor="middle" font-family="Arial" font-size="30" fill="%232196F3"%3EFamily Wedding Photo%3C/text%3E%3C/svg%3E',
        'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="800" height="400"%3E%3Crect fill="%23F3E5F5" width="800" height="400"/%3E%3Ctext x="400" y="200" text-anchor="middle" font-family="Arial" font-size="30" fill="%239C27B0"%3EGraduation Ceremony%3C/text%3E%3C/svg%3E',
        'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="800" height="400"%3E%3Crect fill="%23E8F5E9" width="800" height="400"/%3E%3Ctext x="400" y="200" text-anchor="middle" font-family="Arial" font-size="30" fill="%234CAF50"%3ESummer Vacation%3C/text%3E%3C/svg%3E'
      ];
      
      viewer.innerHTML = `
        <img src="${placeholderImages[index % placeholderImages.length]}" 
             alt="${memory.semantic?.description || 'Memory'}" 
             class="memory-image">
        <div class="memory-details">
          <div class="memory-caption">
            ${memory.semantic?.description || memory.metadata?.title || 'Untitled Memory'}
          </div>
          <div class="memory-metadata">
            ${memory.semantic?.date ? new Date(memory.semantic.date).toLocaleDateString() : ''}
            ${memory.semantic?.people?.length ? `‚Ä¢ ${memory.semantic.people.join(', ')}` : ''}
          </div>
        </div>
      `;
      
      // Update companion state
      if (companion) {
        companion.state.currentMemory = {
          id: memory.id,
          type: memory.semantic?.type || 'photo',
          caption: memory.semantic?.description
        };
        
        // Log view event
        companion.logInteraction({
          timestamp: Date.now(),
          action: 'viewed_memory',
          memoryId: memory.id,
          context: { currentMemoryIndex: index }
        });
      }
    }
    
    function navigateMemory(direction) {
      const newIndex = currentMemoryIndex + direction;
      if (newIndex >= 0 && newIndex < memories.length) {
        displayMemory(newIndex);
        updateNavigation();
      }
    }
    
    function updateNavigation() {
      document.getElementById('prev-btn').disabled = currentMemoryIndex === 0;
      document.getElementById('next-btn').disabled = currentMemoryIndex === memories.length - 1;
    }
    
    function initializeCompanion() {
      const orbContainer = document.getElementById('emma-orb');
      companion = new EmmaDementiaCompanion(orbContainer, {
        stage: 'EARLY',
        voiceEnabled: true,
        userName: 'dear'
      });
      
      // Override conversation logging to update UI
      const originalProcess = companion.processSpeech;
      companion.processSpeech = function(transcript) {
        originalProcess.call(this, transcript);
        updateConversationLog(transcript, this.state.lastInteraction?.emmaResponse);
        updatePatterns();
      };
      
      // Start monitoring
      setInterval(updatePatterns, 5000);
    }
    
    function updateConversationLog(userText, emmaText) {
      const log = document.getElementById('conversation-log');
      const time = new Date().toLocaleTimeString();
      
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <div><span class="log-user">You:</span> ${userText}</div>
        ${emmaText ? `<div><span class="log-emma">Emma:</span> ${emmaText}</div>` : ''}
      `;
      
      // Clear placeholder
      if (log.querySelector('p')) {
        log.innerHTML = '';
      }
      
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }
    
    function updatePatterns() {
      if (!companion) return;
      
      // Update repetitions
      const repetitions = Array.from(companion.state.recentQuestions.values())
        .filter(q => q.count > 1).length;
      document.getElementById('pattern-repetitions').textContent = repetitions;
      
      // Update engagement time
      const minutes = Math.floor((Date.now() - sessionStart) / 60000);
      document.getElementById('pattern-engagement').textContent = `${minutes} min`;
      
      // Update memory updates
      document.getElementById('pattern-updates').textContent = updateCount;
      
      // Update emotional state
      const emotion = companion.state.emotionalState || 'neutral';
      const emotionDisplay = {
        neutral: 'Neutral üòä',
        happy: 'Happy üòÑ',
        confused: 'Confused üòï',
        anxious: 'Anxious üòü'
      };
      document.getElementById('pattern-emotion').textContent = emotionDisplay[emotion] || emotion;
    }
    
    async function addDemoMemories() {
      const demoMemories = [
        {
          type: 'photo',
          content: 'Susan wearing a beautiful white dress at her wedding',
          metadata: {
            title: "Susan's Wedding Day",
            type: 'photo',
            source: 'demo'
          },
          semantic: {
            type: 'photo',
            description: "Susan's wedding at the garden venue",
            date: '2018-06-15',
            people: ['Susan', 'Mark', 'Family'],
            location: 'Rose Garden',
            emotions: ['joy', 'celebration']
          }
        },
        {
          type: 'photo',
          content: 'David in graduation cap and gown receiving his medical degree',
          metadata: {
            title: "David's Medical School Graduation",
            type: 'photo',
            source: 'demo'
          },
          semantic: {
            type: 'photo',
            description: "David graduating from medical school",
            date: '2019-05-20',
            people: ['David', 'Mom', 'Dad'],
            location: 'University Auditorium',
            emotions: ['pride', 'achievement']
          }
        },
        {
          type: 'photo',
          content: 'Family gathered at the lake house for summer vacation',
          metadata: {
            title: 'Summer at the Lake House',
            type: 'photo',
            source: 'demo'
          },
          semantic: {
            type: 'photo',
            description: 'Annual family vacation at the lake',
            date: '2020-07-04',
            people: ['Whole Family', 'Grandchildren'],
            location: 'Lake Tahoe',
            emotions: ['relaxation', 'togetherness']
          }
        }
      ];
      
      try {
        for (const memory of demoMemories) {
          await window.emmaAPI.memories.save(memory);
        }
        
        alert('Demo memories added successfully!');
        await loadMemories();
      } catch (error) {
        console.error('Failed to add demo memories:', error);
        alert('Failed to add demo memories. Please check console.');
      }
    }
    
    async function showCaregiverReport() {
      if (!companion) {
        alert('Please wait for Emma to initialize');
        return;
      }
      
      const report = await companion.generateCaregiverReport();
      const patterns = await companion.analyzeHistoricalPatterns();
      
      const reportContent = document.getElementById('report-content');
      reportContent.innerHTML = `
        <h3>Daily Summary - ${report.date}</h3>
        
        <div style="background: #E3F2FD; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <h4>Engagement Overview</h4>
          <p><strong>Total Interactions:</strong> ${report.interactions}</p>
          <p><strong>Session Duration:</strong> ${Math.floor((Date.now() - sessionStart) / 60000)} minutes</p>
          <p><strong>Memories Viewed:</strong> ${memories.length > 0 ? currentMemoryIndex + 1 : 0} of ${memories.length}</p>
        </div>
        
        <div style="background: #FFF3E0; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <h4>Behavioral Patterns</h4>
          ${report.patterns.repetition?.size > 0 ? 
            `<p>‚ö†Ô∏è <strong>Repetitive Questions:</strong> ${report.patterns.repetition.size} questions repeated multiple times</p>` : 
            '<p>‚úì <strong>No concerning repetition patterns detected</strong></p>'}
          <p><strong>Emotional State:</strong> Generally ${companion.state.emotionalState || 'neutral'}</p>
          <p><strong>Confusion Episodes:</strong> ${patterns?.confusionEpisodes?.length || 0}</p>
        </div>
        
        <div style="background: #E8F5E9; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <h4>Positive Observations</h4>
          <p>‚Ä¢ User engaged well with family photos</p>
          <p>‚Ä¢ Best response to memories involving ${patterns?.positiveTopics?.size > 0 ? Array.from(patterns.positiveTopics).join(', ') : 'family members'}</p>
          <p>‚Ä¢ Most active during ${patterns?.timeOfDayActivity ? 'current session' : 'morning hours'}</p>
        </div>
        
        <div style="background: #F3E5F5; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <h4>Care Recommendations</h4>
          ${report.recommendations.length > 0 ?
            report.recommendations.map(r => `<p>‚Ä¢ ${r.message}</p>`).join('') :
            `<p>‚Ä¢ Continue regular photo viewing sessions</p>
             <p>‚Ä¢ Focus on memories with clear faces and familiar settings</p>
             <p>‚Ä¢ Allow extra time for processing and response</p>`}
        </div>
        
        <div style="background: #FFEBEE; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <h4>Action Items</h4>
          <p>‚Ä¢ Schedule next session during peak engagement time</p>
          <p>‚Ä¢ Prepare photos of ${patterns?.positiveTopics?.size > 0 ? 'similar positive topics' : 'family gatherings'}</p>
          <p>‚Ä¢ Consider involving ${memories[currentMemoryIndex]?.semantic?.people?.[0] || 'family members'} in next session</p>
        </div>
      `;
      
      document.getElementById('caregiver-report').style.display = 'block';
    }
    
    function closeCaregiverReport() {
      document.getElementById('caregiver-report').style.display = 'none';
    }
  </script>
</body>
</html>

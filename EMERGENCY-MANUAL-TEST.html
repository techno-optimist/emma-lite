<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emma E2E Import/Export Test</title>
  <link rel="stylesheet" href="css/main.css">
  <style>
    body { padding: 20px; }
    .card { background: var(--emma-card-bg); border:1px solid var(--emma-border); border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:8px; border:1px solid var(--emma-border); background:rgba(255,255,255,0.08); color:var(--emma-text); cursor:pointer; }
    pre { background: rgba(0,0,0,0.4); padding:12px; border-radius:8px; color:#e9d5ff; max-height: 280px; overflow:auto; }
    input[type="file"] { display:none; }
  </style>
</head>
<body>
  <h2>Emma E2E Import/Export Test</h2>
  <div class="card">
    <div class="row">
      <button id="create-sample">Create 3 Sample Memories</button>
      <button id="export-json">Export Data (JSON)</button>
      <button id="clear-all">Clear All Memories</button>
      <button id="import-json">Import Data (pick file)</button>
      <input type="file" id="json-file" accept="application/json">
    </div>
    <pre id="log"></pre>
  </div>

  <div class="card">
    <div class="row">
      <button id="vault-export">Vault: Export Secure Backup</button>
      <button id="vault-import">Vault: Restore Secure Backup</button>
      <input type="file" id="vault-file" accept="application/json">
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    function log(msg, obj) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[# ${time}] ${msg}\n`;
      if (obj) logEl.textContent += JSON.stringify(obj, null, 2) + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    document.getElementById('create-sample').onclick = async () => {
      try {
        const samples = [
          { content:'Sample note A', role:'user', source:'test', type:'note' },
          { content:'Sample note B', role:'assistant', source:'test', type:'note' },
          { content:'Conversation start', role:'user', source:'test', type:'conversation' }
        ];
        for (const m of samples) {
          const r = await chrome.runtime.sendMessage({ action:'saveMemory', data: m });
          log('Saved memory', r);
        }
        const stats = await chrome.runtime.sendMessage({ action:'getStats' });
        log('Stats after save', stats);
      } catch (e) {
        log('Error creating sample', { error: e.message });
      }
    };

    document.getElementById('export-json').onclick = async () => {
      try {
        const resp = await chrome.runtime.sendMessage({ action:'exportData' });
        if (!resp?.success) throw new Error(resp?.error||'export failed');
        const blob = new Blob([JSON.stringify(resp.data,null,2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'emma-export.json'; a.click(); URL.revokeObjectURL(url);
        log('Exported data', { bytes: blob.size });
      } catch (e) { log('Export error', { error: e.message }); }
    };

    document.getElementById('clear-all').onclick = async () => {
      try {
        const r = await chrome.runtime.sendMessage({ action:'clearMemories', confirmToken:'CONFIRM_DELETE_ALL', origin:'EMERGENCY-MANUAL-TEST' });
        log('Cleared', r);
      } catch (e) { log('Clear error', { error: e.message }); }
    };

    document.getElementById('import-json').onclick = () => document.getElementById('json-file').click();
    document.getElementById('json-file').onchange = async (e) => {
      try {
        const file = e.target.files[0]; if (!file) return; const txt = await file.text();
        const data = JSON.parse(txt);
        const r = await chrome.runtime.sendMessage({ action:'importData', data });
        log('Imported', r);
      } catch (e2) { log('Import error', { error: e2.message }); } finally { e.target.value = ''; }
    };

    document.getElementById('vault-export').onclick = async () => {
      try {
        const backupPassphrase = prompt('Enter backup encryption passphrase (min 12 chars):');
        if (!backupPassphrase || backupPassphrase.length < 12) return log('Export cancelled - passphrase too short');
        const r = await chrome.runtime.sendMessage({ action:'vault.exportFile', backupPassphrase });
        if (!r?.success) throw new Error(r?.error||'vault export failed');
        const blob = new Blob([JSON.stringify(r.backup,null,2)],{ type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = r.filename; a.click(); URL.revokeObjectURL(url);
        log('Vault exported', { filename: r.filename, size: r.size });
      } catch (e) { log('Vault export error', { error: e.message }); }
    };

    document.getElementById('vault-import').onclick = () => document.getElementById('vault-file').click();
    document.getElementById('vault-file').onchange = async (e) => {
      try {
        const file = e.target.files[0]; if (!file) return; const txt = await file.text();
        const data = JSON.parse(txt);
        const backupPassphrase = prompt('Enter backup encryption passphrase:'); if (!backupPassphrase) return;
        const newPassphrase = prompt('Enter NEW passphrase for restored vault:'); if (!newPassphrase) return;
        const r = await chrome.runtime.sendMessage({ action:'vault.restoreBackup', backupData: data, backupPassphrase, newPassphrase, options:{ generateNewId:true } });
        log('Vault restore result', r);
      } catch (e2) { log('Vault import error', { error: e2.message }); } finally { e.target.value = ''; }
    };
  </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Emergency Manual Test</title>
</head>
<body style="padding:20px;background:#f0f0f0;">
    <h2>ðŸš¨ Emergency Manual Test</h2>
    <p>Open this file in Chrome to test if JavaScript works outside extension context.</p>
    
    <button onclick="alert('JavaScript works in regular browser!')" 
            style="padding:15px;background:green;color:white;border:none;margin:10px;font-size:16px;">
        Test JavaScript in Browser
    </button>
    
    <button id="manual-test" 
            style="padding:15px;background:blue;color:white;border:none;margin:10px;font-size:16px;">
        Test addEventListener
    </button>
    
    <div id="output" style="background:#333;color:white;padding:15px;margin:10px;min-height:100px;font-family:monospace;"></div>
    
    <script>
        console.log('ðŸ§ª Emergency manual test starting...');
        
        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += message + '<br>';
            console.log(message);
        }
        
        log('âœ… JavaScript execution works');
        log('âœ… DOM manipulation works');
        
        // Test event listener
        const btn = document.getElementById('manual-test');
        if (btn) {
            btn.addEventListener('click', function() {
                log('âœ… addEventListener works');
                log('âœ… All JavaScript functionality confirmed');
                alert('Manual test successful!');
            });
            log('âœ… Event listener attached');
        }
        
        log('--- Manual test ready ---');
        log('If both buttons work here but not in extension,');
        log('the issue is Chrome extension context specific.');
    </script>
</body>
</html>
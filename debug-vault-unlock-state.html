<!DOCTYPE html>
<html>
<head>
    <title>Debug Vault Unlock State</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .test { margin: 10px 0; padding: 10px; background: #333; border-radius: 5px; }
        .pass { background: #2a5c2a; }
        .fail { background: #5c2a2a; }
        button { margin: 5px; padding: 10px; }
        pre { background: #000; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Vault Unlock State Debug</h1>
    
    <button onclick="runTests()">Run All Tests</button>
    <button onclick="testVaultStatus()">Test Vault Status</button>
    <button onclick="testKeyringState()">Test Keyring State</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            console.log(`[${type}] ${message}`);
        }
        
        function clearResults() {
            results.innerHTML = '';
        }
        
        async function runTests() {
            clearResults();
            log('üîç Starting comprehensive vault state debug...', 'info');
            
            await testVaultStatus();
            await testKeyringState();
            await testSessionState();
            await testVaultUnlock();
        }
        
        async function testVaultStatus() {
            try {
                log('Testing vault.getStatus...', 'info');
                const status = await chrome.runtime.sendMessage({ action: 'vault.getStatus' });
                
                if (status && status.success) {
                    log(`‚úÖ Vault Status: initialized=${status.initialized}, isUnlocked=${status.isUnlocked}`, 'pass');
                    log(`Session: hasValidSession=${status.hasValidSession}, expiresAt=${status.sessionExpiresAt}`, 'info');
                    log(`Debug info: ${JSON.stringify(status.debug, null, 2)}`, 'info');
                } else {
                    log(`‚ùå Vault status failed: ${JSON.stringify(status)}`, 'fail');
                }
            } catch (e) {
                log(`‚ùå Vault status error: ${e.message}`, 'fail');
            }
        }
        
        async function testKeyringState() {
            try {
                log('Testing vault debug info...', 'info');
                const debug = await chrome.runtime.sendMessage({ action: 'vault.debug' });
                
                if (debug && debug.success) {
                    log(`üîê Keyring State:`, 'info');
                    log(`<pre>${JSON.stringify(debug.debug, null, 2)}</pre>`, 'info');
                } else {
                    log(`‚ùå Debug info failed: ${JSON.stringify(debug)}`, 'fail');
                }
            } catch (e) {
                log(`‚ùå Debug info error: ${e.message}`, 'fail');
            }
        }
        
        async function testSessionState() {
            try {
                log('Testing raw Chrome storage...', 'info');
                const storage = await chrome.storage.local.get([
                    'emma_vault_initialized',
                    'emma_vault_settings',
                    'emma_vault_session',
                    'emma_vault_state'
                ]);
                
                log(`üì¶ Raw Storage:`, 'info');
                log(`<pre>${JSON.stringify(storage, null, 2)}</pre>`, 'info');
                
                // Check if session is valid
                const session = storage.emma_vault_session;
                if (session && session.expiresAt) {
                    const now = Date.now();
                    const isExpired = session.expiresAt <= now;
                    log(`‚è∞ Session expires: ${new Date(session.expiresAt).toLocaleString()} (${isExpired ? 'EXPIRED' : 'VALID'})`, isExpired ? 'fail' : 'pass');
                }
            } catch (e) {
                log(`‚ùå Storage check error: ${e.message}`, 'fail');
            }
        }
        
        async function testVaultUnlock() {
            try {
                log('Testing vault list capsules...', 'info');
                const list = await chrome.runtime.sendMessage({ action: 'vault.listCapsules', limit: 5 });
                
                if (list && list.success) {
                    log(`‚úÖ List capsules works: ${list.items ? list.items.length : 0} items`, 'pass');
                } else {
                    log(`‚ùå List capsules failed: ${JSON.stringify(list)}`, 'fail');
                    
                    // If it fails, try to understand why
                    if (list && list.error && list.error.includes('locked')) {
                        log(`üîí Keyring appears to be locked despite status saying unlocked`, 'fail');
                    }
                }
            } catch (e) {
                log(`‚ùå List capsules error: ${e.message}`, 'fail');
            }
        }
        
        // Auto-run on load
        window.addEventListener('DOMContentLoaded', () => {
            log('Debug tool loaded. Click "Run All Tests" to start.', 'info');
        });
    </script>
</body>
</html>

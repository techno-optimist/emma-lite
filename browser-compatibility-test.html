<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emma Browser Compatibility Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }
    
    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .test-result.pass {
      background: rgba(16, 185, 129, 0.3);
      border-left: 4px solid #10b981;
    }
    
    .test-result.fail {
      background: rgba(239, 68, 68, 0.3);
      border-left: 4px solid #ef4444;
    }
    
    .test-result.warn {
      background: rgba(245, 158, 11, 0.3);
      border-left: 4px solid #f59e0b;
    }
    
    .browser-info {
      background: rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    
    button {
      background: linear-gradient(135deg, #8B5CF6, #F093FB);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin: 10px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    .error-details {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üß™ Emma Browser Compatibility Test</h1>
    <p>Testing Emma's core functionality across different browsers</p>
    
    <div class="browser-info" id="browserInfo">
      <h3>üåê Browser Information</h3>
      <div id="browserDetails"></div>
    </div>
    
    <div id="testResults">
      <h3>üîç Compatibility Test Results</h3>
    </div>
    
    <div style="margin-top: 30px;">
      <button onclick="runAllTests()">üöÄ Run All Tests</button>
      <button onclick="testFileSystemAccess()">üìÅ Test File System Access</button>
      <button onclick="testWebCrypto()">üîê Test Web Crypto</button>
      <button onclick="testIndexedDB()">üíæ Test IndexedDB</button>
      <button onclick="testLocalStorage()">üóÉÔ∏è Test Storage</button>
    </div>
  </div>

  <script>
    // Browser detection and compatibility testing
    class EmmaBrowserCompatibilityTest {
      constructor() {
        this.results = [];
        this.browserInfo = this.detectBrowser();
        this.displayBrowserInfo();
      }
      
      detectBrowser() {
        const userAgent = navigator.userAgent;
        const vendor = navigator.vendor;
        
        let browser = 'Unknown';
        let version = 'Unknown';
        let engine = 'Unknown';
        
        // Detect browser
        if (/Chrome/.test(userAgent) && /Google Inc/.test(vendor)) {
          if (/Brave/.test(userAgent) || navigator.brave) {
            browser = 'Brave';
          } else if (/Edg/.test(userAgent)) {
            browser = 'Edge';
          } else {
            browser = 'Chrome';
          }
          const match = userAgent.match(/Chrome\/(\d+)/);
          version = match ? match[1] : 'Unknown';
          engine = 'Blink';
        } else if (/Firefox/.test(userAgent)) {
          browser = 'Firefox';
          const match = userAgent.match(/Firefox\/(\d+)/);
          version = match ? match[1] : 'Unknown';
          engine = 'Gecko';
        } else if (/Safari/.test(userAgent) && !/Chrome/.test(userAgent)) {
          browser = 'Safari';
          const match = userAgent.match(/Version\/(\d+)/);
          version = match ? match[1] : 'Unknown';
          engine = 'WebKit';
        }
        
        // Additional Brave detection
        if (navigator.brave && navigator.brave.isBrave) {
          browser = 'Brave';
        }
        
        return {
          browser,
          version,
          engine,
          userAgent,
          vendor,
          platform: navigator.platform,
          language: navigator.language,
          cookieEnabled: navigator.cookieEnabled,
          onLine: navigator.onLine
        };
      }
      
      displayBrowserInfo() {
        const info = this.browserInfo;
        document.getElementById('browserDetails').innerHTML = `
          <strong>Browser:</strong> ${info.browser} ${info.version} (${info.engine})<br>
          <strong>Platform:</strong> ${info.platform}<br>
          <strong>Language:</strong> ${info.language}<br>
          <strong>Cookies Enabled:</strong> ${info.cookieEnabled}<br>
          <strong>Online:</strong> ${info.onLine}<br>
          <strong>User Agent:</strong> <small>${info.userAgent}</small>
        `;
      }
      
      addTestResult(testName, status, message, details = null) {
        const result = { testName, status, message, details, timestamp: new Date() };
        this.results.push(result);
        this.displayTestResult(result);
      }
      
      displayTestResult(result) {
        const resultsDiv = document.getElementById('testResults');
        const resultDiv = document.createElement('div');
        resultDiv.className = `test-result ${result.status}`;
        
        let statusIcon = '‚ùì';
        if (result.status === 'pass') statusIcon = '‚úÖ';
        else if (result.status === 'fail') statusIcon = '‚ùå';
        else if (result.status === 'warn') statusIcon = '‚ö†Ô∏è';
        
        resultDiv.innerHTML = `
          <strong>${statusIcon} ${result.testName}</strong><br>
          ${result.message}
          ${result.details ? `<div class="error-details">${result.details}</div>` : ''}
        `;
        
        resultsDiv.appendChild(resultDiv);
      }
      
      async testFileSystemAccess() {
        console.log('üß™ Testing File System Access API...');
        
        try {
          // Test 1: Check if File System Access API is available
          if (!('showOpenFilePicker' in window)) {
            this.addTestResult(
              'File System Access API Support',
              'fail',
              'showOpenFilePicker not available - Emma will use fallback file input method',
              'This means users cannot save directly to their .emma files and must download updated files'
            );
            return false;
          }
          
          this.addTestResult(
            'File System Access API Support',
            'pass',
            'showOpenFilePicker is available'
          );
          
          // Test 2: Check for other File System Access APIs
          const hasShowSaveFilePicker = 'showSaveFilePicker' in window;
          const hasShowDirectoryPicker = 'showDirectoryPicker' in window;
          
          this.addTestResult(
            'File System Access API Features',
            hasShowSaveFilePicker ? 'pass' : 'warn',
            `showSaveFilePicker: ${hasShowSaveFilePicker}, showDirectoryPicker: ${hasShowDirectoryPicker}`
          );
          
          // Test 3: Test actual file picker (user interaction required)
          this.addTestResult(
            'File Picker Test',
            'warn',
            'Click "Test File Picker" button to test actual file selection functionality'
          );
          
          return true;
          
        } catch (error) {
          this.addTestResult(
            'File System Access API Test',
            'fail',
            'Error testing File System Access API',
            error.toString()
          );
          return false;
        }
      }
      
      async testWebCrypto() {
        console.log('üß™ Testing Web Crypto API...');
        
        try {
          // Test 1: Check if Web Crypto is available
          if (!window.crypto || !window.crypto.subtle) {
            this.addTestResult(
              'Web Crypto API Support',
              'fail',
              'Web Crypto API not available - Emma vault encryption will not work'
            );
            return false;
          }
          
          this.addTestResult(
            'Web Crypto API Support',
            'pass',
            'Web Crypto API is available'
          );
          
          // Test 2: Test key generation
          const key = await window.crypto.subtle.generateKey(
            {
              name: 'AES-GCM',
              length: 256
            },
            true,
            ['encrypt', 'decrypt']
          );
          
          this.addTestResult(
            'Web Crypto Key Generation',
            'pass',
            'Successfully generated AES-GCM key'
          );
          
          // Test 3: Test encryption/decryption
          const data = new TextEncoder().encode('Emma test data');
          const iv = window.crypto.getRandomValues(new Uint8Array(12));
          
          const encrypted = await window.crypto.subtle.encrypt(
            { name: 'AES-GCM', iv },
            key,
            data
          );
          
          const decrypted = await window.crypto.subtle.decrypt(
            { name: 'AES-GCM', iv },
            key,
            encrypted
          );
          
          const decryptedText = new TextDecoder().decode(decrypted);
          
          if (decryptedText === 'Emma test data') {
            this.addTestResult(
              'Web Crypto Encryption/Decryption',
              'pass',
              'Successfully encrypted and decrypted test data'
            );
          } else {
            this.addTestResult(
              'Web Crypto Encryption/Decryption',
              'fail',
              'Encryption/decryption test failed - data mismatch'
            );
          }
          
          return true;
          
        } catch (error) {
          this.addTestResult(
            'Web Crypto API Test',
            'fail',
            'Error testing Web Crypto API',
            error.toString()
          );
          return false;
        }
      }
      
      async testIndexedDB() {
        console.log('üß™ Testing IndexedDB...');
        
        try {
          // Test 1: Check if IndexedDB is available
          if (!window.indexedDB) {
            this.addTestResult(
              'IndexedDB Support',
              'fail',
              'IndexedDB not available - Emma cannot store vault data locally'
            );
            return false;
          }
          
          this.addTestResult(
            'IndexedDB Support',
            'pass',
            'IndexedDB is available'
          );
          
          // Test 2: Test database creation and operations
          const dbName = 'EmmaCompatibilityTest';
          const dbVersion = 1;
          
          const db = await new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, dbVersion);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains('testStore')) {
                db.createObjectStore('testStore', { keyPath: 'id' });
              }
            };
          });
          
          // Test 3: Test read/write operations
          const transaction = db.transaction(['testStore'], 'readwrite');
          const store = transaction.objectStore('testStore');
          
          await new Promise((resolve, reject) => {
            const request = store.add({ id: 'test', data: 'Emma test data' });
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
          
          const retrievedData = await new Promise((resolve, reject) => {
            const request = store.get('test');
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
          
          db.close();
          
          // Clean up test database
          await new Promise((resolve, reject) => {
            const deleteRequest = indexedDB.deleteDatabase(dbName);
            deleteRequest.onsuccess = () => resolve();
            deleteRequest.onerror = () => reject(deleteRequest.error);
          });
          
          if (retrievedData && retrievedData.data === 'Emma test data') {
            this.addTestResult(
              'IndexedDB Operations',
              'pass',
              'Successfully created, wrote, and read from IndexedDB'
            );
          } else {
            this.addTestResult(
              'IndexedDB Operations',
              'fail',
              'IndexedDB operations failed - data mismatch'
            );
          }
          
          return true;
          
        } catch (error) {
          this.addTestResult(
            'IndexedDB Test',
            'fail',
            'Error testing IndexedDB',
            error.toString()
          );
          return false;
        }
      }
      
      async testLocalStorage() {
        console.log('üß™ Testing Local Storage...');
        
        try {
          // Test 1: Check if localStorage is available
          if (!window.localStorage) {
            this.addTestResult(
              'Local Storage Support',
              'fail',
              'localStorage not available - Emma cannot store settings'
            );
            return false;
          }
          
          this.addTestResult(
            'Local Storage Support',
            'pass',
            'localStorage is available'
          );
          
          // Test 2: Test storage operations
          const testKey = 'emmaCompatibilityTest';
          const testValue = JSON.stringify({ test: 'Emma test data', timestamp: Date.now() });
          
          localStorage.setItem(testKey, testValue);
          const retrievedValue = localStorage.getItem(testKey);
          localStorage.removeItem(testKey);
          
          if (retrievedValue === testValue) {
            this.addTestResult(
              'Local Storage Operations',
              'pass',
              'Successfully stored and retrieved data from localStorage'
            );
          } else {
            this.addTestResult(
              'Local Storage Operations',
              'fail',
              'localStorage operations failed - data mismatch'
            );
          }
          
          // Test 3: Check sessionStorage
          if (window.sessionStorage) {
            sessionStorage.setItem(testKey, testValue);
            const sessionRetrieved = sessionStorage.getItem(testKey);
            sessionStorage.removeItem(testKey);
            
            this.addTestResult(
              'Session Storage',
              sessionRetrieved === testValue ? 'pass' : 'fail',
              sessionRetrieved === testValue ? 'sessionStorage working correctly' : 'sessionStorage failed'
            );
          } else {
            this.addTestResult(
              'Session Storage',
              'fail',
              'sessionStorage not available'
            );
          }
          
          return true;
          
        } catch (error) {
          this.addTestResult(
            'Local Storage Test',
            'fail',
            'Error testing localStorage',
            error.toString()
          );
          return false;
        }
      }
      
      async testBraveSpecific() {
        console.log('üß™ Testing Brave-specific features...');
        
        try {
          // Test 1: Detect if this is Brave
          const isBrave = !!(navigator.brave && navigator.brave.isBrave);
          
          this.addTestResult(
            'Brave Browser Detection',
            isBrave ? 'pass' : 'warn',
            isBrave ? 'Brave browser detected' : 'Not Brave browser (or Brave not detected)'
          );
          
          if (isBrave) {
            // Test 2: Check Brave shields status
            try {
              const shieldsStatus = await navigator.brave.isBrave();
              this.addTestResult(
                'Brave Shields Status',
                'pass',
                'Brave shields API accessible'
              );
            } catch (error) {
              this.addTestResult(
                'Brave Shields Status',
                'warn',
                'Cannot determine Brave shields status',
                error.toString()
              );
            }
          }
          
          return true;
          
        } catch (error) {
          this.addTestResult(
            'Brave Specific Test',
            'fail',
            'Error testing Brave-specific features',
            error.toString()
          );
          return false;
        }
      }
      
      async testEmmaSpecific() {
        console.log('üß™ Testing Emma-specific functionality...');
        
        try {
          // Test 1: Check if Emma scripts would load
          const emmaScripts = [
            'js/emma-web-vault.js',
            'js/emma-orb.js',
            'js/emma-input-modal.js',
            'js/clean-password-modal.js'
          ];
          
          let scriptsAccessible = 0;
          for (const script of emmaScripts) {
            try {
              const response = await fetch(script, { method: 'HEAD' });
              if (response.ok) scriptsAccessible++;
            } catch (error) {
              // Script not accessible
            }
          }
          
          this.addTestResult(
            'Emma Scripts Accessibility',
            scriptsAccessible === emmaScripts.length ? 'pass' : 'warn',
            `${scriptsAccessible}/${emmaScripts.length} Emma scripts accessible`
          );
          
          // Test 2: Check for potential CSP issues
          const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
          this.addTestResult(
            'Content Security Policy',
            cspMeta ? 'warn' : 'pass',
            cspMeta ? 'CSP detected - may restrict Emma functionality' : 'No restrictive CSP detected'
          );
          
          // Test 3: Test drag and drop support
          const supportsDragDrop = 'ondragstart' in document.createElement('div') && 'ondrop' in document.createElement('div');
          this.addTestResult(
            'Drag and Drop Support',
            supportsDragDrop ? 'pass' : 'fail',
            supportsDragDrop ? 'Drag and drop supported' : 'Drag and drop not supported'
          );
          
          return true;
          
        } catch (error) {
          this.addTestResult(
            'Emma Specific Test',
            'fail',
            'Error testing Emma-specific functionality',
            error.toString()
          );
          return false;
        }
      }
      
      async runAllTests() {
        console.log('üöÄ Running comprehensive Emma compatibility tests...');
        
        // Clear previous results
        document.getElementById('testResults').innerHTML = '<h3>üîç Compatibility Test Results</h3>';
        this.results = [];
        
        try {
          await this.testFileSystemAccess();
          await this.testWebCrypto();
          await this.testIndexedDB();
          await this.testLocalStorage();
          await this.testBraveSpecific();
          await this.testEmmaSpecific();
          
          // Summary
          const passed = this.results.filter(r => r.status === 'pass').length;
          const failed = this.results.filter(r => r.status === 'fail').length;
          const warnings = this.results.filter(r => r.status === 'warn').length;
          
          this.addTestResult(
            'Overall Compatibility',
            failed === 0 ? 'pass' : warnings > 0 ? 'warn' : 'fail',
            `Tests: ${passed} passed, ${failed} failed, ${warnings} warnings`
          );
          
        } catch (error) {
          this.addTestResult(
            'Test Suite Error',
            'fail',
            'Error running compatibility tests',
            error.toString()
          );
        }
      }
      
      async testActualFilePicker() {
        try {
          console.log('üß™ Testing actual file picker...');
          
          if (!('showOpenFilePicker' in window)) {
            this.addTestResult(
              'File Picker Test',
              'fail',
              'showOpenFilePicker not supported - cannot test file picker'
            );
            return;
          }
          
          const [fileHandle] = await window.showOpenFilePicker({
            types: [{
              description: 'Emma Vault Files',
              accept: { 'application/emma-vault': ['.emma'] }
            }],
            excludeAcceptAllOption: true,
            multiple: false
          });
          
          const file = await fileHandle.getFile();
          
          this.addTestResult(
            'File Picker Test',
            'pass',
            `Successfully selected file: ${file.name} (${file.size} bytes)`
          );
          
          // Test write capability
          if ('createWritable' in fileHandle) {
            this.addTestResult(
              'File Write Capability',
              'pass',
              'File handle supports writing - direct save will work'
            );
          } else {
            this.addTestResult(
              'File Write Capability',
              'fail',
              'File handle does not support writing - direct save will not work'
            );
          }
          
        } catch (error) {
          if (error.name === 'AbortError') {
            this.addTestResult(
              'File Picker Test',
              'warn',
              'File picker test cancelled by user'
            );
          } else {
            this.addTestResult(
              'File Picker Test',
              'fail',
              'File picker test failed',
              error.toString()
            );
          }
        }
      }
    }
    
    // Global functions for button clicks
    let compatibilityTest;
    
    window.addEventListener('DOMContentLoaded', () => {
      compatibilityTest = new EmmaBrowserCompatibilityTest();
    });
    
    function runAllTests() {
      compatibilityTest.runAllTests();
    }
    
    function testFileSystemAccess() {
      compatibilityTest.testFileSystemAccess();
    }
    
    function testWebCrypto() {
      compatibilityTest.testWebCrypto();
    }
    
    function testIndexedDB() {
      compatibilityTest.testIndexedDB();
    }
    
    function testLocalStorage() {
      compatibilityTest.testLocalStorage();
    }
    
    function testFilePicker() {
      compatibilityTest.testActualFilePicker();
    }
  </script>
  
  <div style="margin-top: 30px; text-align: center;">
    <button onclick="testFilePicker()">üìÅ Test File Picker (Interactive)</button>
    <button onclick="window.location.href='index.html'">üîô Back to Emma</button>
  </div>
</body>
</html>
